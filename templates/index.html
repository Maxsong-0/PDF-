<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFæ‰¹é‡é‡å‘½åå¤„ç†å·¥å…· - Liquid Glassç²‰è‰²ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, 
                #ff9a9e 0%, 
                #fecfef 25%, 
                #fecfef 50%, 
                #f093fb 75%, 
                #f5576c 100%);
            min-height: 100vh;
            padding: 20px;
            color: #444;
            position: relative;
            overflow-x: hidden;
        }

        /* æç®€èƒŒæ™¯è£…é¥° - æ€§èƒ½ä¼˜åŒ– */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.05);
            z-index: -1;
            pointer-events: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 40px;
            box-shadow: 
                0 20px 40px rgba(255, 182, 193, 0.1),
                0 10px 20px rgba(255, 192, 203, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 182, 193, 0.05) 50%, 
                rgba(255, 255, 255, 0.1) 100%);
            border-radius: 30px;
            z-index: -1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            background: linear-gradient(45deg, #ff6b9d, #c44569, #ff9ff3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 3rem;
            margin-bottom: 15px;
            font-weight: 700;
            text-shadow: 0 4px 8px rgba(255, 107, 157, 0.2);
            letter-spacing: -1px;
        }

        .header p {
            color: rgba(68, 68, 68, 0.8);
            font-size: 1.2rem;
            font-weight: 400;
            opacity: 0.9;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 20px rgba(255, 182, 193, 0.08);
            transition: transform 0.2s ease;
            position: relative;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(255, 182, 193, 0.12);
        }

        .upload-section {
            padding: 40px;
            margin-bottom: 30px;
            border: 2px dashed rgba(255, 182, 193, 0.3);
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: rgba(255, 107, 157, 0.6);
            background: rgba(255, 255, 255, 0.08);
        }

        .upload-area {
            text-align: center;
            padding: 50px 30px;
            cursor: pointer;
            transition: transform 0.2s ease;
            border-radius: 15px;
        }

        .upload-area:hover {
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 4rem;
            background: linear-gradient(45deg, #ff6b9d, #ff9ff3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 25px;
        }

        .upload-text {
            color: #444;
            font-size: 1.4rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .upload-hint {
            color: rgba(68, 68, 68, 0.7);
            font-size: 1rem;
            font-weight: 400;
        }

        #fileInput {
            display: none;
        }

        .glass-btn {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: #444;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px 35px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.2s ease;
            margin: 10px;
            box-shadow: 0 6px 15px rgba(255, 182, 193, 0.08);
        }

        .glass-btn:hover {
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 0.18);
        }

        .glass-btn:active {
            transform: translateY(0);
        }

        .glass-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .glass-btn-primary {
            background: linear-gradient(45deg, 
                rgba(255, 107, 157, 0.3), 
                rgba(255, 159, 243, 0.3));
            color: #444;
            border-color: rgba(255, 107, 157, 0.3);
        }

        .glass-btn-primary:hover {
            background: linear-gradient(45deg, 
                rgba(255, 107, 157, 0.4), 
                rgba(255, 159, 243, 0.4));
        }

        .glass-btn-success {
            background: linear-gradient(45deg, 
                rgba(102, 217, 174, 0.3), 
                rgba(129, 236, 236, 0.3));
            color: #444;
            border-color: rgba(102, 217, 174, 0.3);
        }

        .glass-btn-danger {
            background: linear-gradient(45deg, 
                rgba(255, 107, 157, 0.3), 
                rgba(245, 87, 108, 0.3));
            color: #444;
            border-color: rgba(255, 107, 157, 0.3);
        }

        .results-section {
            margin-top: 30px;
            display: none;
            padding: 30px;
        }

        .results-header {
            color: #444;
            font-size: 1.5rem;
            margin-bottom: 25px;
            font-weight: 600;
            text-align: center;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-left: 4px solid;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 182, 193, 0.05);
            overflow: hidden;
        }

        .result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 182, 193, 0.15);
            background: rgba(255, 255, 255, 0.15);
        }

        .result-header {
            transition: all 0.2s ease;
            border-radius: 8px;
        }

        .result-header:hover {
            background: rgba(255, 255, 255, 0.2) !important;
        }

        .expand-icon {
            user-select: none;
            color: rgba(68, 68, 68, 0.7);
            font-weight: bold;
        }

        .result-details {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .result-summary .result-filename {
            color: #444;
        }

        .result-summary .result-status {
            opacity: 0.8;
        }

        .result-success {
            border-left-color: #66d9ae;
            background: linear-gradient(45deg, 
                rgba(102, 217, 174, 0.1), 
                rgba(255, 255, 255, 0.1));
        }

        .result-error {
            border-left-color: #ff6b9d;
            background: linear-gradient(45deg, 
                rgba(255, 107, 157, 0.1), 
                rgba(255, 255, 255, 0.1));
        }

        .result-filename {
            color: #444;
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .result-message {
            color: rgba(68, 68, 68, 0.8);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .result-log {
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.9rem;
            color: rgba(68, 68, 68, 0.8);
            white-space: pre-line;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .loading {
            display: none;
            text-align: center;
            color: #444;
            margin: 30px 0;
            padding: 40px;
        }

        .ocr-status {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: linear-gradient(45deg, rgba(255, 107, 157, 0.9), rgba(255, 159, 243, 0.9));
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 15px 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            display: none;
            z-index: 1000;
            box-shadow: 0 8px 20px rgba(255, 107, 157, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .spinner {
            border: 4px solid rgba(255, 182, 193, 0.2);
            border-radius: 50%;
            border-top: 4px solid #ff6b9d;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 40px;
        }

        .feature {
            padding: 30px 25px;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .feature:hover {
            transform: translateY(-3px);
        }

        .feature-icon {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #ff6b9d, #ff9ff3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            display: block;
        }

        .feature-title {
            color: #444;
            font-size: 1.2rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .feature-desc {
            color: rgba(68, 68, 68, 0.7);
            font-size: 1rem;
            line-height: 1.6;
            font-weight: 400;
        }

        .drag-over {
            border-color: #ff6b9d !important;
            background: rgba(255, 107, 157, 0.1) !important;
            transform: scale(1.02);
        }

        .file-list {
            margin-top: 25px;
            color: #444;
        }

        .file-list h3 {
            margin-bottom: 15px;
            font-weight: 600;
        }

        .file-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .controls {
            text-align: center;
            margin-top: 30px;
        }

        .backup-info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #444;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 107, 157, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 107, 157, 0.5);
        }

        /* ç°ä»£åŒ–åœ†å½¢è¿›åº¦æ¡ç³»ç»Ÿ */
        .progress-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 30px;
            margin: 20px 0;
            display: none;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .circular-progress {
            position: relative;
            width: 140px;
            height: 140px;
            margin: 0 auto 20px;
        }

        .circular-progress svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
            filter: drop-shadow(0 4px 8px rgba(255, 107, 157, 0.3));
        }

        .progress-ring-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.15);
            stroke-width: 10;
        }

        .progress-ring {
            fill: none;
            stroke: url(#progressGradient);
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dasharray 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 8px rgba(255, 107, 157, 0.5));
        }

        .progress-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8rem;
            font-weight: 800;
            color: #ff6b9d;
            text-shadow: 0 2px 8px rgba(255, 107, 157, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }

        .progress-text {
            color: #444;
            font-weight: 600;
            margin: 15px 0;
            font-size: 1.1rem;
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 25px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px 10px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #ff6b9d;
            display: block;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        /* èƒŒæ™¯è‡ªå®šä¹‰é¢æ¿ */
        .background-customizer {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
            transform: translateX(calc(100% + 20px));
            transition: transform 0.3s ease;
        }

        .background-customizer.open {
            transform: translateX(0);
        }

        .bg-toggle-btn {
            position: fixed;
            top: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }

        .bg-toggle-btn:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.3);
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .color-option.active {
            border-color: #fff;
            box-shadow: 0 0 0 2px rgba(255, 107, 157, 0.5);
        }

        .custom-color-section {
            margin-top: 20px;
        }

        .color-picker-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
        }

        .color-picker {
            width: 50px;
            height: 30px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
        }

        .batch-operations {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .batch-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }



        .performance-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.9rem;
            color: #444;
            display: none;
        }

        /* å®æ—¶æ—¥å¿—çª—å£ */
        .realtime-log {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 400px;
            max-height: 300px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            font-family: 'Courier New', monospace;
            z-index: 1000;
        }

        .log-header {
            background: rgba(255, 107, 157, 0.8);
            padding: 10px 15px;
            color: white;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .log-controls {
            display: flex;
            gap: 8px;
        }

        .log-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .log-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .log-content {
            max-height: 220px;
            overflow-y: auto;
            padding: 10px;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
        }

        .log-timestamp {
            color: #888;
            margin-right: 8px;
        }

        .log-level-info { color: #4CAF50; }
        .log-level-warn { color: #FF9800; }
        .log-level-error { color: #F44336; }
        .log-level-success { color: #8BC34A; }

        /* å¢å¼ºæ€§èƒ½ç›‘æ§é¢æ¿ */
        .performance-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 999;
        }

        .perf-header {
            color: #444;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1rem;
        }

        .perf-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .perf-metric {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }

        .perf-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #ff6b9d;
        }

        .perf-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 3px;
        }

        .perf-chart {
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }

        .chart-bar {
            position: absolute;
            bottom: 0;
            width: 4px;
            background: linear-gradient(45deg, #ff6b9d, #ff9ff3);
            transition: height 0.3s ease;
            border-radius: 2px 2px 0 0;
        }

        /* æ€§èƒ½æ¨¡å¼åˆ‡æ¢å™¨ */
        .performance-toggle {
            position: fixed;
            bottom: 340px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 50px;
            padding: 10px 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #444;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            user-select: none;
            z-index: 999;
        }

        .performance-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .performance-toggle.eco-mode {
            background: rgba(102, 217, 174, 0.2);
            border-color: rgba(102, 217, 174, 0.4);
        }

        /* æ—¥å¿—åˆ‡æ¢æŒ‰é’® */
        .log-toggle {
            position: fixed;
            bottom: 380px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 10px 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            user-select: none;
            z-index: 999;
        }

        .log-toggle:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: translateY(-2px);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .features {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .upload-area {
                padding: 40px 20px;
            }

            .background-customizer {
                right: 10px;
                top: 10px;
                width: calc(100vw - 20px);
                max-width: 300px;
            }

            .bg-toggle-btn {
                right: 20px;
                top: 20px;
            }

            .batch-grid {
                grid-template-columns: 1fr;
            }

            /* ç§»åŠ¨ç«¯å®æ—¶æ—¥å¿—ä¼˜åŒ– */
            .realtime-log {
                width: calc(100vw - 40px);
                max-height: 250px;
                left: 20px;
                bottom: 10px;
            }

            /* ç§»åŠ¨ç«¯æ€§èƒ½é¢æ¿ä¼˜åŒ– */
            .performance-panel {
                width: calc(100vw - 40px);
                right: 20px;
                bottom: 10px;
            }

            .perf-metrics {
                grid-template-columns: repeat(2, 1fr);
            }

            /* ç§»åŠ¨ç«¯æ§åˆ¶æŒ‰é’®ä¼˜åŒ– */
            .performance-toggle, .log-toggle {
                left: 10px;
                padding: 8px 15px;
                font-size: 0.8rem;
            }

            .performance-toggle {
                bottom: 280px;
            }

            .log-toggle {
                bottom: 320px;
            }

            /* ç§»åŠ¨ç«¯åœ†å½¢è¿›åº¦æ¡ä¼˜åŒ– */
            .circular-progress {
                width: 100px;
                height: 100px;
            }

            .progress-stats {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stat-item {
                padding: 10px;
            }
        }

        /* æ–‡ä»¶åˆ—è¡¨å¢å¼ºæ ·å¼ */
        .file-list-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .file-list-header h3 {
            margin: 0;
            color: #444;
        }

        .file-summary {
            font-size: 0.9rem;
            color: rgba(68,68,68,0.8);
        }

        .file-controls {
            margin-left: auto;
        }

        .file-item {
            border-radius: 8px;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .file-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-1px);
        }

        .file-pagination, .results-pagination {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* ç»“æœæ˜¾ç¤ºå¢å¼ºæ ·å¼ */
        .results-header-enhanced {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .results-header-enhanced h3 {
            margin: 0;
            color: #444;
        }

        .results-summary {
            font-size: 0.9rem;
            color: rgba(68,68,68,0.8);
        }

        .results-controls {
            margin-left: auto;
        }

        .results-filter {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .results-filter label {
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.3s ease;
        }

        .results-filter label:hover {
            background: rgba(255,255,255,0.1);
        }

        /* åœ¨æç®€æ¨¡å¼ä¸‹ç®€åŒ–æ ·å¼ */
        .eco-mode-style .file-item,
        .eco-mode-style .result-item {
            transition: none !important;
            background: rgba(255,255,255,0.03) !important;
        }

        .eco-mode-style .file-item:hover,
        .eco-mode-style .result-item:hover {
            transform: none !important;
            background: rgba(255,255,255,0.06) !important;
        }
    </style>
</head>
<body>
    <!-- èƒŒæ™¯è‡ªå®šä¹‰æŒ‰é’® -->
    <div class="bg-toggle-btn" onclick="toggleBackgroundCustomizer()">
        ğŸ¨
    </div>

    <!-- èƒŒæ™¯è‡ªå®šä¹‰é¢æ¿ -->
    <div class="background-customizer" id="backgroundCustomizer">
        <h4 style="color: #444; margin-bottom: 15px; text-align: center;">ğŸ¨ èƒŒæ™¯è‡ªå®šä¹‰</h4>
        
        <div style="color: #444; font-size: 0.9rem; margin-bottom: 10px;">é¢„è®¾ä¸»é¢˜:</div>
        <div class="color-palette">
            <div class="color-option active" data-theme="pink" style="background: linear-gradient(45deg, #ff9a9e, #fecfef);"></div>
            <div class="color-option" data-theme="blue" style="background: linear-gradient(45deg, #667eea, #764ba2);"></div>
            <div class="color-option" data-theme="green" style="background: linear-gradient(45deg, #56ab2f, #a8edea);"></div>
            <div class="color-option" data-theme="purple" style="background: linear-gradient(45deg, #da22ff, #9733ee);"></div>
            <div class="color-option" data-theme="orange" style="background: linear-gradient(45deg, #f093fb, #f5576c);"></div>
            <div class="color-option" data-theme="teal" style="background: linear-gradient(45deg, #4facfe, #00f2fe);"></div>
            <div class="color-option" data-theme="sunset" style="background: linear-gradient(45deg, #fa709a, #fee140);"></div>
            <div class="color-option" data-theme="ocean" style="background: linear-gradient(45deg, #2196f3, #21cbf3);"></div>
        </div>

        <div class="custom-color-section">
            <div style="color: #444; font-size: 0.9rem; margin-bottom: 10px;">è‡ªå®šä¹‰æ¸å˜:</div>
            <div class="color-picker-group">
                <input type="color" id="color1" class="color-picker" value="#ff9a9e">
                <span style="color: #444;">â†’</span>
                <input type="color" id="color2" class="color-picker" value="#fecfef">
            </div>
            <button class="glass-btn" style="width: 100%; margin-top: 10px;" onclick="applyCustomGradient()">
                âœ¨ åº”ç”¨è‡ªå®šä¹‰
            </button>
        </div>

        <div style="margin-top: 20px;">
            <button class="glass-btn" style="width: 100%;" onclick="resetBackground()">
                ğŸ”„ é‡ç½®é»˜è®¤
            </button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸŒ¸ PDFæ‰¹é‡é‡å‘½åå·¥å…·</h1>
            <p>åŸºäºAIé«˜ç²¾åº¦OCRè¯†åˆ«é”€è´§å‡ºåº“å•å·ï¼Œæ™ºèƒ½è§’åº¦æ£€æµ‹ï¼Œå®‰å…¨ä¸‹è½½é‡å‘½åæ–‡ä»¶ - Liquid Glassç²‰è‰²ç‰ˆ</p>
            <div style="background: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 15px; margin-top: 15px; font-size: 0.9rem; color: rgba(68,68,68,0.8);">
                ğŸ”„ <strong>åŒé‡éªŒè¯ç­–ç•¥:</strong> Tesseractå¿«é€Ÿåˆè¯†åˆ« + EasyOCRç²¾ç¡®ç¡®è®¤ï¼Œå…¼é¡¾é€Ÿåº¦ä¸ç²¾åº¦ï¼é¦–æ¬¡ä½¿ç”¨éœ€ä¸‹è½½AIæ¨¡å‹ã€‚
            </div>
        </div>

        <!-- æ‰¹é‡æ“ä½œé¢æ¿ -->
        <div class="glass-card batch-operations">
            <h3 style="color: #444; margin-bottom: 15px; text-align: center;">âš¡ æ‰¹é‡æ“ä½œ</h3>
            <div class="batch-grid">
                <button class="glass-btn" onclick="toggleBackupMode()" id="backupToggleBtn" style="width: 100%;">
                    ğŸ’¾ å¤‡ä»½: å¼€å¯
                </button>
                <button class="glass-btn glass-btn-success" onclick="batchRename()" style="width: 100%;">
                    ğŸ”„ æ‰¹é‡å¤„ç†
                </button>
                <button class="glass-btn" onclick="showPerformanceInfo()" style="width: 100%;">
                    ğŸ“Š æ€§èƒ½ç›‘æ§
                </button>
                <button class="glass-btn" onclick="showPerformanceTips()" style="width: 100%;">
                    ğŸ’¡ æ€§èƒ½ä¼˜åŒ–
                </button>
                <button class="glass-btn" onclick="debugDownloadSystem()" style="width: 100%;">
                    ğŸ”§ è°ƒè¯•ä¸‹è½½
                </button>
            </div>
        </div>

        <div class="glass-card upload-section" id="uploadSection">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»é€‰æ‹©PDFæ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
                <div class="upload-hint">æ”¯æŒå¤šæ–‡ä»¶æ‰¹é‡ä¸Šä¼ ï¼Œè‡ªåŠ¨è¯†åˆ«é”€è´§å‡ºåº“å•å·ï¼Œå¤„ç†åå¯ä¸‹è½½é‡å‘½åæ–‡ä»¶</div>
            </div>
            <input type="file" id="fileInput" multiple accept=".pdf">
            
            <div class="file-list" id="fileList" style="display: none;">
                <div class="file-list-header">
                    <h3 style="margin: 0; display: inline-block;">å·²é€‰æ‹©çš„æ–‡ä»¶ï¼š</h3>
                    <div class="file-summary" id="fileSummary" style="display: inline-block; margin-left: 15px; color: rgba(68,68,68,0.8);"></div>
                    <div class="file-controls" id="fileControls" style="float: right;"></div>
                </div>
                <div id="selectedFiles"></div>
                <div class="file-pagination" id="filePagination" style="display: none;"></div>
            </div>

            <div class="controls">
                <button class="glass-btn glass-btn-primary" onclick="processFiles()" id="processBtn" disabled>
                    ğŸš€ è¯†åˆ«å¹¶å¤„ç†æ–‡ä»¶
                </button>
                <button class="glass-btn glass-btn-danger" onclick="clearFiles()" id="clearBtn">
                    ğŸ—‘ï¸ æ¸…ç†æœåŠ¡å™¨æ–‡ä»¶
                </button>
                <button class="glass-btn" onclick="showBackupInfo()" id="backupBtn">
                    ğŸ“‚ å¤‡ä»½ä¿¡æ¯
                </button>
                <button class="glass-btn" onclick="autoFixUploads()" id="autoFixBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    ğŸ”§ è‡ªåŠ¨ä¿®å¤ä¸‹è½½
                </button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>æ­£åœ¨å¤„ç†PDFæ–‡ä»¶ï¼Œè¯·ç¨å€™...</div>
        </div>

        <!-- ç°ä»£åŒ–åœ†å½¢è¿›åº¦æ¡ -->
        <div class="progress-container" id="progressContainer">
            <div class="circular-progress">
                <svg>
                    <defs>
                        <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#ff6b9d"/>
                            <stop offset="100%" style="stop-color:#ff9ff3"/>
                        </linearGradient>
                    </defs>
                    <circle class="progress-ring-bg" cx="70" cy="70" r="60"></circle>
                    <circle class="progress-ring" cx="70" cy="70" r="60" 
                            stroke-dasharray="377" stroke-dashoffset="377" id="progressRing"></circle>
                </svg>
                <div class="progress-percentage" id="progressPercentage">0%</div>
            </div>
            <div class="progress-text" id="progressText">å‡†å¤‡å¤„ç†...</div>
            <div class="progress-stats">
                <div class="stat-item">
                    <span class="stat-value" id="statFiles">0</span>
                    <div class="stat-label">å·²å¤„ç†æ–‡ä»¶</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="statSpeed">0</span>
                    <div class="stat-label">å¤„ç†é€Ÿåº¦/ç§’</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="statETA">--</span>
                    <div class="stat-label">é¢„è®¡å‰©ä½™æ—¶é—´</div>
                </div>
            </div>
        </div>

        <div class="glass-card results-section" id="resultsSection">
            <div class="results-header-enhanced">
                <h3 style="margin: 0; display: inline-block;">å¤„ç†ç»“æœ</h3>
                <div class="results-summary" id="resultsSummary" style="display: inline-block; margin-left: 15px; color: rgba(68,68,68,0.8);"></div>
                <div class="results-controls" id="resultsControls" style="float: right;"></div>
            </div>
            <div class="results-filter" id="resultsFilter" style="display: none; margin: 15px 0;"></div>
            <div id="results"></div>
            <div class="results-pagination" id="resultsPagination" style="display: none;"></div>
            <div id="backupInfo" class="backup-info" style="display: none;"></div>
        </div>



        <div class="glass-card" style="margin-top: 30px;" id="backupSection" style="display: none;">
            <div style="padding: 30px;">
                <h3 style="color: #444; margin-bottom: 20px; text-align: center;">ğŸ“‚ å¤‡ä»½ç®¡ç†</h3>
                <div id="backupDetails"></div>
                <div class="controls">
                    <button class="glass-btn glass-btn-danger" onclick="clearAllBackups()">
                        ğŸ—‘ï¸ æ¸…ç†æ‰€æœ‰å¤‡ä»½
                    </button>
                </div>
            </div>
        </div>

        <div class="features">
            <div class="glass-card feature">
                <div class="feature-icon">âš¡</div>
                <div class="feature-title">åŒé‡éªŒè¯OCR</div>
                <div class="feature-desc">Tesseractå¿«é€Ÿæ‰«æ+EasyOCRç²¾ç¡®éªŒè¯ï¼Œæ™ºèƒ½åŒå¼•æ“ç¡®ä¿æœ€é«˜è¯†åˆ«ç²¾åº¦</div>
            </div>
            <div class="glass-card feature">
                <div class="feature-icon">ğŸ”„</div>
                <div class="feature-title">æ™ºèƒ½è§’åº¦æ£€æµ‹</div>
                <div class="feature-desc">ä¸‰ç§æ–¹æ³•ç»¼åˆåˆ¤æ–­æ–‡æ¡£è§’åº¦ï¼Œè‡ªåŠ¨æ ¡æ­£æ—‹è½¬æ–‡æ¡£</div>
            </div>
            <div class="glass-card feature">
                <div class="feature-icon">ğŸ“‚</div>
                <div class="feature-title">å®‰å…¨ä¸‹è½½ç³»ç»Ÿ</div>
                <div class="feature-desc">å¤„ç†åæä¾›é‡å‘½åæ–‡ä»¶ä¸‹è½½ï¼ŒåŸæ–‡ä»¶è‡ªåŠ¨å¤‡ä»½ä¿æŠ¤</div>
            </div>
            <div class="glass-card feature">
                <div class="feature-icon">ğŸ’</div>
                <div class="feature-title">Liquid Glassç•Œé¢</div>
                <div class="feature-desc">ç°ä»£åŒ–ç²‰è‰²ç»ç’ƒè´¨æ„Ÿç•Œé¢ï¼Œç¾è§‚æ˜“ç”¨çš„æ“ä½œä½“éªŒ</div>
            </div>
        </div>
    </div>

    <!-- å®æ—¶æ—¥å¿—çª—å£ -->
    <div class="realtime-log" id="realtimeLog">
        <div class="log-header">
            <span>ğŸ“Š å®æ—¶å¤„ç†æ—¥å¿—</span>
            <div class="log-controls">
                <button class="log-btn" onclick="clearLogs()">æ¸…ç©º</button>
                <button class="log-btn" onclick="exportLogs()">å¯¼å‡º</button>
                <button class="log-btn" onclick="toggleLogVisibility()">Ã—</button>
            </div>
        </div>
        <div class="log-content" id="logContent">
            <div class="log-entry">
                <span class="log-timestamp">--:--:--</span>
                <span class="log-level-info">ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…æ–‡ä»¶å¤„ç†...</span>
            </div>
        </div>
    </div>

    <!-- å¢å¼ºæ€§èƒ½ç›‘æ§é¢æ¿ -->
    <div class="performance-panel" id="performancePanel">
        <div class="perf-header">ğŸ“ˆ æ€§èƒ½ç›‘æ§ä¸­å¿ƒ</div>
        <div class="perf-metrics">
            <div class="perf-metric">
                <div class="perf-value" id="perfFiles">0</div>
                <div class="perf-label">å¤„ç†æ–‡ä»¶</div>
            </div>
            <div class="perf-metric">
                <div class="perf-value" id="perfTime">0s</div>
                <div class="perf-label">æ€»è€—æ—¶</div>
            </div>
            <div class="perf-metric">
                <div class="perf-value" id="perfMemory">--</div>
                <div class="perf-label">å†…å­˜ä½¿ç”¨</div>
            </div>
            <div class="perf-metric">
                <div class="perf-value" id="perfCPU">--</div>
                <div class="perf-label">CPUä½¿ç”¨</div>
            </div>
        </div>
        <div class="perf-chart" id="perfChart">
            <!-- åŠ¨æ€ç”Ÿæˆçš„æ€§èƒ½å›¾è¡¨æ¡ -->
        </div>
        <div style="font-size: 0.8rem; color: #666; text-align: center; margin-top: 10px;">
            <span id="perfOCR">OCRå¼•æ“: å¾…æ£€æµ‹</span>
        </div>
    </div>

    <!-- æ§åˆ¶æŒ‰é’®ç»„ -->
    <div class="log-toggle" onclick="toggleLogVisibility()">
        ğŸ“‹ å®æ—¶æ—¥å¿—
    </div>

    <div class="performance-toggle" id="performanceToggle" onclick="togglePerformanceMode()">
        ğŸš€ æ ‡å‡†æ¨¡å¼
    </div>

    <!-- åŒé‡éªŒè¯OCRçŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="ocr-status" id="ocrStatus">
        âš¡ åŒé‡éªŒè¯OCRè¯†åˆ«ä¸­...
    </div>

    <script>
        let selectedFiles = [];
        let isProcessing = false;
        let backupMode = true; // é»˜è®¤å¼€å¯å¤‡ä»½
        let ecoMode = false; // æ€§èƒ½æ¨¡å¼
        let performanceData = {
            processedFiles: 0,
            startTime: null,
            memoryUsage: 0
        };

        // å¤„ç†ç»“æœç®¡ç†
        let processResults = [];
        let resultsState = {
            currentPage: 1,
            itemsPerPage: 10,
            filter: 'all', // 'all', 'success', 'error'
            allExpanded: false,
            showPagination: false
        };

        // å®æ—¶æ—¥å¿—ç³»ç»Ÿ
        let logEntries = [];
        let logVisible = false;
        
        // æ€§èƒ½ç›‘æ§å¢å¼ºæ•°æ®
        let performanceChart = {
            data: [],
            maxPoints: 50
        };

        // èƒŒæ™¯ä¸»é¢˜é…ç½®
        const backgroundThemes = {
            pink: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 25%, #fecfef 50%, #f093fb 75%, #f5576c 100%)',
            blue: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            green: 'linear-gradient(135deg, #56ab2f 0%, #a8edea 100%)',
            purple: 'linear-gradient(135deg, #da22ff 0%, #9733ee 100%)',
            orange: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            teal: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
            sunset: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
            ocean: 'linear-gradient(135deg, #2196f3 0%, #21cbf3 100%)'
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initColorPalette();
            initPerformanceMonitoring();
            initBackupMode();
            loadSavedBackground(); // æ–°å¢ï¼šåŠ è½½ä¿å­˜çš„èƒŒæ™¯
            initPerformanceMode(); // æ–°å¢ï¼šåˆå§‹åŒ–æ€§èƒ½æ¨¡å¼
            
            // æ–°å¢åˆå§‹åŒ–
            addLog('PDFæ‰¹é‡é‡å‘½åå·¥å…·å·²å°±ç»ª - åŒé‡éªŒè¯OCRç‰ˆæœ¬', 'success');
            initEnhancedPerformanceMonitoring();
            
            // æ·»åŠ é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'l') {
                    e.preventDefault();
                    toggleLogVisibility();
                }
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    togglePerformancePanel();
                }
            });
        });

        // æ–°å¢ï¼šåŠ è½½ä¿å­˜çš„èƒŒæ™¯è®¾ç½®
        function loadSavedBackground() {
            // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰æ¸å˜
            const customGradient = localStorage.getItem('customGradient');
            if (customGradient) {
                document.body.style.background = customGradient;
                // ç§»é™¤æ‰€æœ‰é¢„è®¾ä¸»é¢˜çš„activeçŠ¶æ€
                document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
                return;
            }
            
            // ç„¶åæ£€æŸ¥æ˜¯å¦æœ‰é€‰æ‹©çš„ä¸»é¢˜
            const selectedTheme = localStorage.getItem('selectedTheme');
            if (selectedTheme && backgroundThemes[selectedTheme]) {
                applyTheme(selectedTheme);
                // è®¾ç½®å¯¹åº”ä¸»é¢˜çš„activeçŠ¶æ€
                const themeOption = document.querySelector(`[data-theme="${selectedTheme}"]`);
                if (themeOption) {
                    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
                    themeOption.classList.add('active');
                }
            }
            
            // å¦‚æœæœ‰ä¿å­˜çš„è‡ªå®šä¹‰é¢œè‰²ï¼Œä¹Ÿè¦æ¢å¤åˆ°é¢œè‰²é€‰æ‹©å™¨ä¸­
            const savedColor1 = localStorage.getItem('customColor1');
            const savedColor2 = localStorage.getItem('customColor2');
            if (savedColor1) document.getElementById('color1').value = savedColor1;
            if (savedColor2) document.getElementById('color2').value = savedColor2;
        }

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        document.getElementById('fileInput').addEventListener('change', function(e) {
            selectedFiles = Array.from(e.target.files);
            updateFileList();
        });

        // æ‹–æ‹½ä¸Šä¼ 
        const uploadSection = document.getElementById('uploadSection');
        
        uploadSection.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadSection.classList.add('drag-over');
        });

        uploadSection.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadSection.classList.remove('drag-over');
        });

        uploadSection.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadSection.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files).filter(file => 
                file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')
            );
            
            if (files.length > 0) {
                selectedFiles = files;
                updateFileList();
            } else {
                alert('è¯·é€‰æ‹©PDFæ–‡ä»¶ï¼');
            }
        });

        // æ–‡ä»¶åˆ—è¡¨ç®¡ç†çŠ¶æ€
        let fileListState = {
            currentPage: 1,
            itemsPerPage: 10,
            isCollapsed: false,
            showAll: false
        };

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const selectedFilesDiv = document.getElementById('selectedFiles');
            const fileSummary = document.getElementById('fileSummary');
            const fileControls = document.getElementById('fileControls');
            const filePagination = document.getElementById('filePagination');
            const processBtn = document.getElementById('processBtn');

            if (selectedFiles.length === 0) {
                fileList.style.display = 'none';
                processBtn.disabled = true;
                return;
            }

            fileList.style.display = 'block';
            processBtn.disabled = false;

            // è®¡ç®—æ–‡ä»¶æ€»å¤§å°
            const totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
            const totalSizeMB = (totalSize / 1024 / 1024).toFixed(2);
            
            // æ›´æ–°æ‘˜è¦ä¿¡æ¯
            const fileCount = selectedFiles.length;
            fileSummary.innerHTML = `
                <span style="font-weight: 600;">${fileCount} ä¸ªæ–‡ä»¶</span>
                <span style="margin-left: 10px;">æ€»è®¡ ${totalSizeMB} MB</span>
                ${fileCount > 50 ? '<span style="color: #ff6b9d; margin-left: 10px;">âš ï¸ æ–‡ä»¶æ•°é‡è¾ƒå¤š</span>' : ''}
            `;

            // æ›´æ–°æ§åˆ¶æŒ‰é’®
            fileControls.innerHTML = generateFileControls();

            // æ ¹æ®æ–‡ä»¶æ•°é‡å†³å®šæ˜¾ç¤ºç­–ç•¥
            if (fileCount <= 5) {
                // å°‘é‡æ–‡ä»¶ï¼šç›´æ¥æ˜¾ç¤ºå…¨éƒ¨
                renderFileList(selectedFiles, false);
                filePagination.style.display = 'none';
            } else if (fileCount <= 20) {
                // ä¸­ç­‰æ•°é‡ï¼šæä¾›æŠ˜å é€‰é¡¹ï¼Œé»˜è®¤æ˜¾ç¤ºå…¨éƒ¨
                if (fileListState.isCollapsed) {
                    renderFileList(selectedFiles.slice(0, 5), true);
                } else {
                    renderFileList(selectedFiles, false);
                }
                filePagination.style.display = 'none';
            } else {
                // å¤§é‡æ–‡ä»¶ï¼šé»˜è®¤æŠ˜å ï¼Œåˆ†é¡µæ˜¾ç¤º
                if (fileListState.showAll) {
                    renderPaginatedFileList();
                } else {
                    renderFileList(selectedFiles.slice(0, 5), true);
                    filePagination.style.display = 'none';
                }
            }

            // æ€§èƒ½è­¦å‘Š
            if (fileCount > 50) {
                showFilePerformanceWarning(fileCount);
            }
        }

        function generateFileControls() {
            const fileCount = selectedFiles.length;
            let controls = [];

            if (fileCount > 5) {
                if (fileCount <= 20) {
                    // ä¸­ç­‰æ•°é‡æ–‡ä»¶çš„æ§åˆ¶
                    const toggleText = fileListState.isCollapsed ? 'å±•å¼€å…¨éƒ¨' : 'æŠ˜å åˆ—è¡¨';
                    const toggleIcon = fileListState.isCollapsed ? 'ğŸ“–' : 'ğŸ“‹';
                    controls.push(`
                        <button class="glass-btn" onclick="toggleFileListCollapse()" style="padding: 5px 10px; font-size: 0.8rem; margin-right: 5px;">
                            ${toggleIcon} ${toggleText}
                        </button>
                    `);
                } else {
                    // å¤§é‡æ–‡ä»¶çš„æ§åˆ¶
                    if (fileListState.showAll) {
                        controls.push(`
                            <button class="glass-btn" onclick="toggleShowAllFiles()" style="padding: 5px 10px; font-size: 0.8rem; margin-right: 5px;">
                                ğŸ“‹ æ”¶èµ·åˆ—è¡¨
                            </button>
                        `);
                    } else {
                        controls.push(`
                            <button class="glass-btn" onclick="toggleShowAllFiles()" style="padding: 5px 10px; font-size: 0.8rem; margin-right: 5px;">
                                ğŸ“– åˆ†é¡µæµè§ˆ
                            </button>
                        `);
                    }
                }
            }

            // æ¸…ç†æŒ‰é’®
            controls.push(`
                <button class="glass-btn glass-btn-danger" onclick="clearSelectedFiles()" style="padding: 5px 10px; font-size: 0.8rem;">
                    ğŸ—‘ï¸ æ¸…ç©º
                </button>
            `);

            return controls.join('');
        }

        function renderFileList(files, showMoreHint = false) {
            const selectedFilesDiv = document.getElementById('selectedFiles');
            
            let html = files.map((file, index) => 
                `<div class="file-item" style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                    <div style="flex: 1; display: flex; align-items: center;">
                        <span style="margin-right: 10px; color: rgba(68,68,68,0.6); font-size: 0.8rem;">${index + 1}.</span>
                        <span style="flex: 1;">ğŸ“„ ${file.name.length > 40 ? file.name.substring(0, 40) + '...' : file.name}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: rgba(68,68,68,0.7); font-size: 0.9rem;">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                        <button onclick="removeFile(${selectedFiles.indexOf(file)})" style="background: none; border: none; color: #ff6b9d; cursor: pointer; padding: 2px;">
                            âœ•
                        </button>
                    </div>
                </div>`
            ).join('');

            if (showMoreHint && selectedFiles.length > files.length) {
                const remainingCount = selectedFiles.length - files.length;
                html += `
                    <div style="text-align: center; padding: 15px; color: rgba(68,68,68,0.6); font-style: italic;">
                        ... è¿˜æœ‰ ${remainingCount} ä¸ªæ–‡ä»¶æœªæ˜¾ç¤º
                    </div>
                `;
            }

            selectedFilesDiv.innerHTML = html;
        }

        function renderPaginatedFileList() {
            const totalPages = Math.ceil(selectedFiles.length / fileListState.itemsPerPage);
            const startIndex = (fileListState.currentPage - 1) * fileListState.itemsPerPage;
            const endIndex = startIndex + fileListState.itemsPerPage;
            const currentPageFiles = selectedFiles.slice(startIndex, endIndex);

            renderFileList(currentPageFiles);

            // æ¸²æŸ“åˆ†é¡µæ§ä»¶
            const filePagination = document.getElementById('filePagination');
            filePagination.style.display = 'block';
            filePagination.innerHTML = generatePaginationControls(totalPages);
        }

        function generatePaginationControls(totalPages) {
            if (totalPages <= 1) return '';

            let controls = ['<div style="text-align: center; padding: 15px;">'];
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            if (fileListState.currentPage > 1) {
                controls.push(`
                    <button class="glass-btn" onclick="changeFilePage(${fileListState.currentPage - 1})" style="margin: 0 5px; padding: 5px 10px;">
                        â† ä¸Šä¸€é¡µ
                    </button>
                `);
            }

            // é¡µç æ˜¾ç¤º
            controls.push(`
                <span style="margin: 0 15px; color: rgba(68,68,68,0.8);">
                    ç¬¬ ${fileListState.currentPage} é¡µ / å…± ${totalPages} é¡µ
                </span>
            `);

            // ä¸‹ä¸€é¡µæŒ‰é’®
            if (fileListState.currentPage < totalPages) {
                controls.push(`
                    <button class="glass-btn" onclick="changeFilePage(${fileListState.currentPage + 1})" style="margin: 0 5px; padding: 5px 10px;">
                        ä¸‹ä¸€é¡µ â†’
                    </button>
                `);
            }

            controls.push('</div>');
            return controls.join('');
        }

        // æ–‡ä»¶åˆ—è¡¨æ§åˆ¶å‡½æ•°
        function toggleFileListCollapse() {
            fileListState.isCollapsed = !fileListState.isCollapsed;
            updateFileList();
            addLog(`æ–‡ä»¶åˆ—è¡¨${fileListState.isCollapsed ? 'æŠ˜å ' : 'å±•å¼€'}`, 'info');
        }

        function toggleShowAllFiles() {
            fileListState.showAll = !fileListState.showAll;
            fileListState.currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            updateFileList();
            addLog(`${fileListState.showAll ? 'å¼€å¯' : 'å…³é—­'}åˆ†é¡µæµè§ˆæ¨¡å¼`, 'info');
        }

        function changeFilePage(newPage) {
            fileListState.currentPage = newPage;
            renderPaginatedFileList();
            addLog(`åˆ‡æ¢åˆ°ç¬¬${newPage}é¡µ`, 'info');
        }

        function removeFile(index) {
            if (index >= 0 && index < selectedFiles.length) {
                const fileName = selectedFiles[index].name;
                selectedFiles.splice(index, 1);
                updateFileList();
                addLog(`ç§»é™¤æ–‡ä»¶: ${fileName}`, 'info');
            }
        }

        function clearSelectedFiles() {
            if (selectedFiles.length > 0 && confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ ${selectedFiles.length} ä¸ªå·²é€‰æ‹©çš„æ–‡ä»¶å—ï¼Ÿ`)) {
                const count = selectedFiles.length;
                selectedFiles = [];
                updateFileList();
                
                // é‡ç½®æ–‡ä»¶è¾“å…¥
                document.getElementById('fileInput').value = '';
                
                addLog(`æ¸…ç©ºäº† ${count} ä¸ªé€‰æ‹©çš„æ–‡ä»¶`, 'success');
            }
        }

        function showFilePerformanceWarning(fileCount) {
            // é¿å…é‡å¤æ˜¾ç¤ºè­¦å‘Š
            if (sessionStorage.getItem('fileWarningShown') === 'true') {
                return;
            }

            setTimeout(() => {
                const shouldContinue = confirm(`
âš ï¸ æ€§èƒ½æé†’

æ‚¨é€‰æ‹©äº† ${fileCount} ä¸ªæ–‡ä»¶ï¼Œè¿™å¯èƒ½ä¼šï¼š
â€¢ å ç”¨è¾ƒå¤šå†…å­˜å’Œå¤„ç†æ—¶é—´
â€¢ å½±å“ç•Œé¢å“åº”é€Ÿåº¦
â€¢ å¢åŠ ç½‘ç»œä¼ è¾“è´Ÿæ‹…

å»ºè®®ï¼š
âœ… åˆ†æ‰¹å¤„ç†ï¼ˆæ¯æ¬¡10-20ä¸ªæ–‡ä»¶ï¼‰
âœ… å¼€å¯æç®€æ¨¡å¼ä»¥æå‡æ€§èƒ½
âœ… å…³é—­å…¶ä»–æµè§ˆå™¨æ ‡ç­¾é¡µ

æ˜¯å¦ç»§ç»­å¤„ç†å½“å‰æ–‡ä»¶ï¼Ÿ
ï¼ˆç‚¹å‡»"å–æ¶ˆ"å¯ä»¥é‡æ–°é€‰æ‹©æ–‡ä»¶ï¼‰
                `);

                if (!shouldContinue) {
                    clearSelectedFiles();
                } else {
                    sessionStorage.setItem('fileWarningShown', 'true');
                    // è‡ªåŠ¨åˆ‡æ¢åˆ°æç®€æ¨¡å¼
                    if (!ecoMode) {
                        const switchToEco = confirm('æ˜¯å¦åˆ‡æ¢åˆ°æç®€æ¨¡å¼ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Ÿ');
                        if (switchToEco) {
                            togglePerformanceMode();
                        }
                    }
                }
            }, 500);
        }

        // ============ ç»“æœæ˜¾ç¤ºç®¡ç†ç³»ç»Ÿ ============
        function updateResultsDisplay() {
            if (!processResults || processResults.length === 0) return;

            const results = document.getElementById('results');
            const resultsSummary = document.getElementById('resultsSummary');
            const resultsControls = document.getElementById('resultsControls');
            const resultsFilter = document.getElementById('resultsFilter');
            const resultsPagination = document.getElementById('resultsPagination');

            // æ›´æ–°æ‘˜è¦ä¿¡æ¯
            const successCount = processResults.filter(r => r.success).length;
            const errorCount = processResults.length - successCount;
            resultsSummary.innerHTML = `
                <span style="font-weight: 600;">${processResults.length} ä¸ªç»“æœ</span>
                <span style="margin-left: 10px; color: #4CAF50;">âœ… ${successCount}</span>
                <span style="margin-left: 10px; color: #f44336;">âŒ ${errorCount}</span>
            `;

            // æ›´æ–°æ§åˆ¶æŒ‰é’®
            resultsControls.innerHTML = generateResultsControls();

            // æ›´æ–°ç­›é€‰å™¨
            if (processResults.length > 10) {
                resultsFilter.style.display = 'block';
                resultsFilter.innerHTML = generateResultsFilter();
            } else {
                resultsFilter.style.display = 'none';
            }

            // æ ¹æ®ç»“æœæ•°é‡å†³å®šæ˜¾ç¤ºç­–ç•¥
            if (processResults.length <= 10) {
                // å°‘é‡ç»“æœï¼šç›´æ¥æ˜¾ç¤ºå…¨éƒ¨
                renderResults(processResults);
                resultsPagination.style.display = 'none';
                resultsState.showPagination = false;
            } else {
                // å¤§é‡ç»“æœï¼šåˆ†é¡µæ˜¾ç¤º
                if (resultsState.showPagination) {
                    renderPaginatedResults();
                } else {
                    // é»˜è®¤æŠ˜å æ˜¾ç¤ºå‰5ä¸ª
                    renderResults(processResults.slice(0, 5), true);
                    resultsPagination.style.display = 'none';
                }
            }
        }

        function generateResultsControls() {
            const resultCount = processResults.length;
            let controls = [];

            if (resultCount > 10) {
                // å¤§é‡ç»“æœçš„æ§åˆ¶
                if (resultsState.showPagination) {
                    controls.push(`
                        <button class="glass-btn" onclick="toggleResultsPagination()" style="padding: 5px 10px; font-size: 0.8rem; margin-right: 5px;">
                            ğŸ“‹ æ”¶èµ·ç»“æœ
                        </button>
                    `);
                } else {
                    controls.push(`
                        <button class="glass-btn" onclick="toggleResultsPagination()" style="padding: 5px 10px; font-size: 0.8rem; margin-right: 5px;">
                            ğŸ“– åˆ†é¡µæµè§ˆ
                        </button>
                    `);
                }
            }

            // å±•å¼€/æŠ˜å æ§åˆ¶
            if (resultCount > 5) {
                const toggleText = resultsState.allExpanded ? 'æŠ˜å æ‰€æœ‰' : 'å±•å¼€æ‰€æœ‰';
                const toggleIcon = resultsState.allExpanded ? 'ğŸ“‹' : 'ğŸ“–';
                controls.push(`
                    <button class="glass-btn" onclick="toggleAllResultDetails()" style="padding: 5px 10px; font-size: 0.8rem; margin-right: 5px;">
                        ${toggleIcon} ${toggleText}
                    </button>
                `);
            }

            // å¯¼å‡ºæŒ‰é’®
            controls.push(`
                <button class="glass-btn" onclick="exportResults()" style="padding: 5px 10px; font-size: 0.8rem;">
                    ğŸ“„ å¯¼å‡ºæŠ¥å‘Š
                </button>
            `);

            return controls.join('');
        }

        function generateResultsFilter() {
            return `
                <div style="text-align: center;">
                    <label style="margin-right: 20px;">
                        <input type="radio" name="resultFilter" value="all" ${resultsState.filter === 'all' ? 'checked' : ''} onchange="changeResultsFilter('all')" style="margin-right: 5px;">
                        ğŸ” å…¨éƒ¨ (${processResults.length})
                    </label>
                    <label style="margin-right: 20px;">
                        <input type="radio" name="resultFilter" value="success" ${resultsState.filter === 'success' ? 'checked' : ''} onchange="changeResultsFilter('success')" style="margin-right: 5px;">
                        âœ… æˆåŠŸ (${processResults.filter(r => r.success).length})
                    </label>
                    <label>
                        <input type="radio" name="resultFilter" value="error" ${resultsState.filter === 'error' ? 'checked' : ''} onchange="changeResultsFilter('error')" style="margin-right: 5px;">
                        âŒ å¤±è´¥ (${processResults.filter(r => !r.success).length})
                    </label>
                </div>
            `;
        }

        function renderResults(resultsToShow, showMoreHint = false) {
            const results = document.getElementById('results');
            
            let html = resultsToShow.map((result, index) => 
                `<div class="result-item ${result.success ? 'result-success' : 'result-error'}" data-index="${index}">
                    <div class="result-header" onclick="toggleResultDetails(${processResults.indexOf(result)})" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 15px; border-radius: 8px; background: rgba(255,255,255,0.1);">
                        <div class="result-summary">
                            <div class="result-filename" style="font-weight: 600; margin-bottom: 5px;">
                                ${result.success ? 'âœ…' : 'âŒ'} ${result.filename.length > 50 ? result.filename.substring(0, 50) + '...' : result.filename}
                            </div>
                            <div class="result-status" style="font-size: 0.9rem; color: rgba(68,68,68,0.8);">
                                ${result.success ? 
                                    `æˆåŠŸé‡å‘½åä¸º: ${(result.new_filename || 'æœªçŸ¥').length > 40 ? (result.new_filename || 'æœªçŸ¥').substring(0, 40) + '...' : (result.new_filename || 'æœªçŸ¥')}` : 
                                    'å¤„ç†å¤±è´¥'
                                }
                            </div>
                        </div>
                        <div class="result-actions" style="display: flex; align-items: center; gap: 10px;">
                            ${result.success ? `
                                <button class="glass-btn glass-btn-success" onclick="event.stopPropagation(); console.log('ä¸‹è½½: ${result.new_filename}'); downloadSingleFile('${result.new_filename || result.filename}')" style="padding: 8px 15px; font-size: 0.9rem;">
                                    ğŸ’¾ ä¸‹è½½
                                </button>
                            ` : ''}
                            <span class="expand-icon" id="expand-icon-${processResults.indexOf(result)}" style="font-size: 1.2rem; transition: transform 0.3s ease;">
                                ${resultsState.allExpanded ? 'â–²' : 'â–¼'}
                            </span>
                        </div>
                    </div>
                    <div class="result-details" id="details-${processResults.indexOf(result)}" style="display: ${resultsState.allExpanded ? 'block' : 'none'}; padding: 15px; margin-top: 10px; background: rgba(0,0,0,0.1); border-radius: 8px; border-left: 4px solid ${result.success ? '#4CAF50' : '#f44336'};">
                        <div class="result-message" style="margin-bottom: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px;">
                            <strong>å¤„ç†æ¶ˆæ¯:</strong><br>
                            ${result.message}
                        </div>
                        ${result.new_filename ? `
                            <div class="result-rename-info" style="margin-bottom: 10px; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 6px;">
                                <strong>é‡å‘½åä¿¡æ¯:</strong><br>
                                ğŸ“„ åŸæ–‡ä»¶å: ${result.filename}<br>
                                â¡ï¸ æ–°æ–‡ä»¶å: ${result.new_filename}<br>
                                ${result.order_number ? `ğŸ”¢ è¯†åˆ«å·ç : ${result.order_number}` : ''}
                            </div>
                        ` : ''}
                        ${result.backup_path && result.backup_path !== 'æœªå¯ç”¨å¤‡ä»½' ? `
                            <div class="result-backup-info" style="margin-bottom: 10px; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 6px;">
                                <strong>å¤‡ä»½ä¿¡æ¯:</strong><br>
                                ğŸ“‚ å¤‡ä»½è·¯å¾„: ${result.backup_path}
                            </div>
                        ` : ''}
                        <div class="result-log" style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; font-family: monospace; font-size: 0.85rem; max-height: 200px; overflow-y: auto;">
                            <strong>OCRè¯†åˆ«æ—¥å¿—:</strong><br>
                            ${result.log.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                </div>`
            ).join('');

            if (showMoreHint && processResults.length > resultsToShow.length) {
                const remainingCount = processResults.length - resultsToShow.length;
                html += `
                    <div style="text-align: center; padding: 20px; color: rgba(68,68,68,0.6); font-style: italic; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: 15px;">
                        ... è¿˜æœ‰ ${remainingCount} ä¸ªç»“æœæœªæ˜¾ç¤º
                        <br><button class="glass-btn" onclick="toggleResultsPagination()" style="margin-top: 10px; padding: 8px 15px;">ğŸ“– æŸ¥çœ‹å…¨éƒ¨</button>
                    </div>
                `;
            }

            results.innerHTML = html;
        }

        function renderPaginatedResults() {
            const filteredResults = getFilteredResults();
            const totalPages = Math.ceil(filteredResults.length / resultsState.itemsPerPage);
            const startIndex = (resultsState.currentPage - 1) * resultsState.itemsPerPage;
            const endIndex = startIndex + resultsState.itemsPerPage;
            const currentPageResults = filteredResults.slice(startIndex, endIndex);

            renderResults(currentPageResults);

            // æ¸²æŸ“åˆ†é¡µæ§ä»¶
            const resultsPagination = document.getElementById('resultsPagination');
            resultsPagination.style.display = 'block';
            resultsPagination.innerHTML = generateResultsPaginationControls(totalPages, filteredResults.length);
        }

        function generateResultsPaginationControls(totalPages, totalResults) {
            if (totalPages <= 1) return '';

            let controls = ['<div style="text-align: center; padding: 15px;">'];
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            if (resultsState.currentPage > 1) {
                controls.push(`
                    <button class="glass-btn" onclick="changeResultsPage(${resultsState.currentPage - 1})" style="margin: 0 5px; padding: 5px 10px;">
                        â† ä¸Šä¸€é¡µ
                    </button>
                `);
            }

            // é¡µç æ˜¾ç¤º
            controls.push(`
                <span style="margin: 0 15px; color: rgba(68,68,68,0.8);">
                    ç¬¬ ${resultsState.currentPage} é¡µ / å…± ${totalPages} é¡µ (${totalResults} ä¸ªç»“æœ)
                </span>
            `);

            // ä¸‹ä¸€é¡µæŒ‰é’®
            if (resultsState.currentPage < totalPages) {
                controls.push(`
                    <button class="glass-btn" onclick="changeResultsPage(${resultsState.currentPage + 1})" style="margin: 0 5px; padding: 5px 10px;">
                        ä¸‹ä¸€é¡µ â†’
                    </button>
                `);
            }

            controls.push('</div>');
            return controls.join('');
        }

        function getFilteredResults() {
            if (resultsState.filter === 'all') {
                return processResults;
            } else if (resultsState.filter === 'success') {
                return processResults.filter(r => r.success);
            } else if (resultsState.filter === 'error') {
                return processResults.filter(r => !r.success);
            }
            return processResults;
        }

        // ç»“æœæ§åˆ¶å‡½æ•°
        function toggleResultsPagination() {
            resultsState.showPagination = !resultsState.showPagination;
            resultsState.currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            updateResultsDisplay();
            addLog(`${resultsState.showPagination ? 'å¼€å¯' : 'å…³é—­'}ç»“æœåˆ†é¡µæµè§ˆ`, 'info');
        }

        function toggleAllResultDetails() {
            resultsState.allExpanded = !resultsState.allExpanded;
            updateResultsDisplay();
            addLog(`${resultsState.allExpanded ? 'å±•å¼€' : 'æŠ˜å '}æ‰€æœ‰ç»“æœè¯¦æƒ…`, 'info');
        }

        function changeResultsFilter(filterType) {
            resultsState.filter = filterType;
            resultsState.currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            updateResultsDisplay();
            addLog(`åˆ‡æ¢ç»“æœç­›é€‰: ${filterType}`, 'info');
        }

        function changeResultsPage(newPage) {
            resultsState.currentPage = newPage;
            renderPaginatedResults();
            addLog(`åˆ‡æ¢åˆ°ç»“æœç¬¬${newPage}é¡µ`, 'info');
        }

        function exportResults() {
            if (!processResults || processResults.length === 0) {
                alert('æš‚æ— ç»“æœå¯å¯¼å‡º');
                return;
            }

            const reportData = processResults.map(result => ({
                æ–‡ä»¶å: result.filename,
                å¤„ç†çŠ¶æ€: result.success ? 'æˆåŠŸ' : 'å¤±è´¥',
                æ–°æ–‡ä»¶å: result.new_filename || '',
                è¯†åˆ«å·ç : result.order_number || '',
                å¤„ç†æ¶ˆæ¯: result.message,
                å¤‡ä»½è·¯å¾„: result.backup_path || ''
            }));

            const csvContent = [
                Object.keys(reportData[0]).join(','),
                ...reportData.map(row => Object.values(row).map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pdf-renamer-report-${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            addLog('å¤„ç†æŠ¥å‘Šå·²å¯¼å‡º', 'success');
        }

        // èƒŒæ™¯è‡ªå®šä¹‰åŠŸèƒ½
        function toggleBackgroundCustomizer() {
            const customizer = document.getElementById('backgroundCustomizer');
            customizer.classList.toggle('open');
        }

        function initColorPalette() {
            const colorOptions = document.querySelectorAll('.color-option');
            colorOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // ç§»é™¤å…¶ä»–é€‰é¡¹çš„activeç±»
                    colorOptions.forEach(opt => opt.classList.remove('active'));
                    // æ·»åŠ å½“å‰é€‰é¡¹çš„activeç±»
                    this.classList.add('active');
                    // åº”ç”¨ä¸»é¢˜
                    const theme = this.dataset.theme;
                    applyTheme(theme);
                });
            });
        }

        function applyTheme(themeName) {
            if (backgroundThemes[themeName]) {
                document.body.style.background = backgroundThemes[themeName];
                localStorage.setItem('selectedTheme', themeName);
                localStorage.removeItem('customGradient'); // æ¸…é™¤è‡ªå®šä¹‰æ¸å˜
            }
        }

        function applyCustomGradient() {
            const color1 = document.getElementById('color1').value;
            const color2 = document.getElementById('color2').value;
            const customGradient = `linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`;
            document.body.style.background = customGradient;
            
            // ä¿å­˜è‡ªå®šä¹‰è®¾ç½®
            localStorage.setItem('customGradient', customGradient);
            localStorage.setItem('customColor1', color1);
            localStorage.setItem('customColor2', color2);
            localStorage.removeItem('selectedTheme'); // æ¸…é™¤é¢„è®¾ä¸»é¢˜
            
            // ç§»é™¤æ‰€æœ‰é¢„è®¾ä¸»é¢˜çš„activeçŠ¶æ€
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
        }

        function resetBackground() {
            applyTheme('pink');
            document.querySelector('[data-theme="pink"]').classList.add('active');
            localStorage.removeItem('customGradient');
            localStorage.removeItem('customColor1');
            localStorage.removeItem('customColor2');
            
            // é‡ç½®é¢œè‰²é€‰æ‹©å™¨
            document.getElementById('color1').value = '#ff9a9e';
            document.getElementById('color2').value = '#fecfef';
        }



        // è¿›åº¦æ¡åŠŸèƒ½
        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            initCircularProgress(); // åˆå§‹åŒ–åœ†å½¢è¿›åº¦æ¡
        }

        function updateProgress(current, total, fileName = '') {
            const percent = Math.round((current / total) * 100);
            const progressText = document.getElementById('progressText');
            
            // æ›´æ–°åœ†å½¢è¿›åº¦æ¡
            updateCircularProgress(percent);
            if (progressText) {
                progressText.textContent = `æ­£åœ¨å¤„ç† ${current}/${total} - ${fileName}`;
            }
            
            // å®‰å…¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            const statFiles = document.getElementById('statFiles');
            if (statFiles) {
                statFiles.textContent = current;
            }
            
            // è®¡ç®—å¤„ç†é€Ÿåº¦å’Œé¢„è®¡æ—¶é—´
            if (performanceData.startTime) {
                const elapsed = (Date.now() - performanceData.startTime) / 1000;
                const speed = current / elapsed;
                const remaining = total - current;
                const eta = remaining > 0 ? Math.ceil(remaining / speed) : 0;
                
                const statSpeed = document.getElementById('statSpeed');
                const statETA = document.getElementById('statETA');
                
                if (statSpeed) {
                    statSpeed.textContent = speed.toFixed(1);
                }
                if (statETA) {
                    statETA.textContent = eta > 0 ? `${eta}s` : 'å®Œæˆ';
                }
            }
        }

        function initCircularProgress() {
            const ring = document.getElementById('progressRing');
            if (ring) {
                const circumference = 2 * Math.PI * 60; // r=60
                ring.style.strokeDasharray = circumference;
                ring.style.strokeDashoffset = circumference;
            }
        }

        function updateCircularProgress(percentage) {
            const ring = document.getElementById('progressRing');
            const percentageEl = document.getElementById('progressPercentage');
            
            if (ring) {
                const circumference = 2 * Math.PI * 60;
                const offset = circumference - (percentage / 100) * circumference;
                ring.style.strokeDashoffset = offset;
            }
            
            if (percentageEl) {
                percentageEl.textContent = Math.round(percentage) + '%';
            }
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        // OCRçŠ¶æ€æŒ‡ç¤ºå™¨æ§åˆ¶
        function showOCRStatus(message = 'âš¡ åŒé‡éªŒè¯OCRè¯†åˆ«ä¸­...') {
            const indicator = document.getElementById('ocrStatus');
            if (indicator) {
                indicator.textContent = message;
                indicator.style.display = 'block';
            }
        }

        function hideOCRStatus() {
            const indicator = document.getElementById('ocrStatus');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        function updateOCRStatus(message) {
            const indicator = document.getElementById('ocrStatus');
            if (indicator && indicator.style.display === 'block') {
                indicator.textContent = message;
            }
        }

        // æ€§èƒ½ç›‘æ§åŠŸèƒ½ - é«˜åº¦ä¼˜åŒ–ç‰ˆ
        let performanceInterval = null;
        
        function initPerformanceMonitoring() {
            // åœ¨æç®€æ¨¡å¼ä¸‹ä¸å¯åŠ¨æ€§èƒ½ç›‘æ§
            if (ecoMode) {
                return;
            }
            
            // å¤§å¹…é™ä½æ›´æ–°é¢‘ç‡åˆ°10ç§’ï¼Œåªåœ¨éœ€è¦æ—¶è¿è¡Œ
            if ('memory' in performance) {
                performanceInterval = setInterval(() => {
                    const indicator = document.getElementById('performanceIndicator');
                    if (indicator && indicator.style.display === 'block') {
                        try {
                            const memoryInfo = performance.memory;
                            const memoryUsed = Math.round(memoryInfo.usedJSHeapSize / 1024 / 1024);
                            const memoryElement = document.getElementById('memoryUsage');
                            if (memoryElement) {
                                memoryElement.textContent = memoryUsed + 'MB';
                            }
                        } catch (e) {
                            // å¿½ç•¥é”™è¯¯ï¼Œé¿å…æ§åˆ¶å°è­¦å‘Š
                        }
                    }
                }, 10000); // è¿›ä¸€æ­¥é™ä½åˆ°10ç§’
            }
        }

        function stopPerformanceMonitoring() {
            if (performanceInterval) {
                clearInterval(performanceInterval);
                performanceInterval = null;
            }
        }

        function showPerformanceInfo() {
            if (ecoMode) {
                alert('ğŸŒ¿ æç®€æ¨¡å¼ä¸‹å·²ç¦ç”¨æ€§èƒ½ç›‘æ§ä»¥èŠ‚çœèµ„æº');
                return;
            }
            togglePerformancePanel();
        }

        function updatePerformanceStats() {
            const processedFiles = document.getElementById('processedFiles');
            const processingTime = document.getElementById('processingTime');
            
            if (processedFiles) {
                processedFiles.textContent = performanceData.processedFiles;
            }
            if (processingTime && performanceData.startTime) {
                const elapsed = (Date.now() - performanceData.startTime) / 1000;
                processingTime.textContent = elapsed.toFixed(1);
            }
        }

        // å¤‡ä»½æ¨¡å¼åˆ‡æ¢åŠŸèƒ½
        function toggleBackupMode() {
            backupMode = !backupMode;
            updateBackupButton();
            
            // ä¿å­˜ç”¨æˆ·åå¥½
            localStorage.setItem('backupMode', backupMode);
            
            // æ˜¾ç¤ºçŠ¶æ€å˜åŒ–æç¤º
            const status = backupMode ? 'å¼€å¯' : 'å…³é—­';
            const emoji = backupMode ? 'âœ…' : 'âŒ';
            
            // ä¸´æ—¶æ˜¾ç¤ºçŠ¶æ€å˜åŒ–
            const btn = document.getElementById('backupToggleBtn');
            const originalText = btn.textContent;
            btn.textContent = `${emoji} å¤‡ä»½å·²${status}`;
            
            setTimeout(() => {
                updateBackupButton();
            }, 1500);
        }

        function updateBackupButton() {
            const btn = document.getElementById('backupToggleBtn');
            const status = backupMode ? 'å¼€å¯' : 'å…³é—­';
            const emoji = backupMode ? 'ğŸ’¾' : 'ğŸš«';
            
            btn.textContent = `${emoji} å¤‡ä»½: ${status}`;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            if (backupMode) {
                btn.classList.remove('glass-btn-danger');
                btn.classList.add('glass-btn-success');
            } else {
                btn.classList.remove('glass-btn-success');
                btn.classList.add('glass-btn-danger');
            }
        }

        // åˆå§‹åŒ–å¤‡ä»½æ¨¡å¼
        function initBackupMode() {
            const savedMode = localStorage.getItem('backupMode');
            if (savedMode !== null) {
                backupMode = savedMode === 'true';
            }
            updateBackupButton();
        }

        // åˆå§‹åŒ–æ€§èƒ½æ¨¡å¼
        function initPerformanceMode() {
            const savedEcoMode = localStorage.getItem('ecoMode');
            if (savedEcoMode !== null) {
                ecoMode = savedEcoMode === 'true';
            }
            updatePerformanceModeUI();
            
            if (ecoMode) {
                // ç«‹å³åº”ç”¨æç®€æ¨¡å¼è®¾ç½®
                document.body.style.setProperty('--animation-duration', '0s');
                setTimeout(() => {
                    document.querySelectorAll('*').forEach(el => {
                        el.style.transition = 'none';
                        el.style.animation = 'none';
                    });
                    
                    document.querySelectorAll('.glass-card, .glass-btn').forEach(el => {
                        el.style.backdropFilter = 'blur(5px)';
                        el.style.webkitBackdropFilter = 'blur(5px)';
                    });
                }, 100);
            }
        }

        // æ€§èƒ½æ¨¡å¼åˆ‡æ¢åŠŸèƒ½
        function togglePerformanceMode() {
            ecoMode = !ecoMode;
            updatePerformanceModeUI();
            
            if (ecoMode) {
                applyEcoMode();
                alert('ğŸš€ å·²åˆ‡æ¢åˆ°æç®€æ€§èƒ½æ¨¡å¼ï¼Œç•Œé¢å“åº”æ›´å¿«ï¼');
            } else {
                removeEcoMode();
                alert('âœ¨ å·²åˆ‡æ¢åˆ°æ ‡å‡†æ¨¡å¼ï¼Œæ¢å¤å®Œæ•´è§†è§‰æ•ˆæœï¼');
            }
            
            localStorage.setItem('ecoMode', ecoMode);
        }

        function updatePerformanceModeUI() {
            const toggleBtn = document.getElementById('performanceToggle');
            if (toggleBtn) {
                toggleBtn.textContent = ecoMode ? 'ğŸŒ¿ æç®€æ¨¡å¼' : 'ğŸš€ æ ‡å‡†æ¨¡å¼';
                toggleBtn.classList.toggle('eco-mode', ecoMode);
            }
        }

        // åˆå§‹åŒ–æ€§èƒ½æ¨¡å¼
        function initPerformanceMode() {
            const savedMode = localStorage.getItem('ecoMode');
            if (savedMode !== null) {
                ecoMode = savedMode === 'true';
            }
            
            // å¦‚æœæ˜¯æç®€æ¨¡å¼ï¼Œç«‹å³åº”ç”¨è®¾ç½®
            if (ecoMode) {
                applyEcoMode();
            }
            
            updatePerformanceModeUI();
        }

        // åº”ç”¨æç®€æ¨¡å¼
        function applyEcoMode() {
            // ç§»é™¤æ‰€æœ‰åŠ¨ç”»å’Œè¿‡æ¸¡æ•ˆæœï¼Œç®€åŒ–è§†è§‰æ•ˆæœ
            const style = document.createElement('style');
            style.id = 'eco-mode-style';
            style.textContent = `
                *, *::before, *::after {
                    transition: none !important;
                    animation: none !important;
                }
                .glass-card, .glass-btn, .container, .upload-section {
                    backdrop-filter: blur(3px) !important;
                    -webkit-backdrop-filter: blur(3px) !important;
                    background: rgba(255, 255, 255, 0.08) !important;
                    box-shadow: 0 2px 8px rgba(255, 182, 193, 0.05) !important;
                }
                .glass-card:hover, .glass-btn:hover, .feature:hover, .upload-area:hover {
                    transform: none !important;
                }
                .result-log {
                    max-height: 100px !important;
                }
                .performance-indicator {
                    display: none !important;
                }
            `;
            document.head.appendChild(style);
        }

        // ç§»é™¤æç®€æ¨¡å¼æ ·å¼
        function removeEcoMode() {
            const ecoStyle = document.getElementById('eco-mode-style');
            if (ecoStyle) {
                ecoStyle.remove();
            }
        }

        // æ˜¾ç¤ºæ€§èƒ½ä¼˜åŒ–å»ºè®®
        function showPerformanceTips() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                background: rgba(0,0,0,0.5); z-index: 10000; 
                display: flex; align-items: center; justify-content: center;
            `;
            modal.innerHTML = `
                <div class="glass-card" style="max-width: 500px; margin: 20px; padding: 30px;">
                    <h3 style="margin-bottom: 20px; text-align: center; color: #444;">ğŸ’¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®</h3>
                    <div style="margin-bottom: 20px; color: #444;">
                        <h4 style="margin-bottom: 10px;">ğŸš€ å¦‚æœè§‰å¾—ç•Œé¢å¡é¡¿ï¼Œå»ºè®®ï¼š</h4>
                        <ul style="padding-left: 20px; line-height: 1.6;">
                            <li>ç‚¹å‡»å·¦ä¸‹è§’"${ecoMode ? 'ğŸŒ¿ æç®€æ¨¡å¼' : 'ğŸš€ æ ‡å‡†æ¨¡å¼'}"åˆ‡æ¢åˆ°æç®€æ¨¡å¼</li>
                            <li>å…³é—­å…¶ä»–æµè§ˆå™¨æ ‡ç­¾é¡µå’Œç¨‹åº</li>
                            <li>æ¯æ¬¡å¤„ç†æ–‡ä»¶æ•°é‡æ§åˆ¶åœ¨10ä¸ªä»¥å†…</li>
                            <li>å¤„ç†å¤§æ–‡ä»¶æ—¶è€å¿ƒç­‰å¾…ï¼Œé¿å…é‡å¤ç‚¹å‡»</li>
                        </ul>
                        <h4 style="margin: 15px 0 10px;">âš¡ æç®€æ¨¡å¼ç‰¹ç‚¹ï¼š</h4>
                        <ul style="padding-left: 20px; line-height: 1.6;">
                            <li>ç§»é™¤æ‰€æœ‰åŠ¨ç”»æ•ˆæœï¼Œç•Œé¢å“åº”æ›´å¿«</li>
                            <li>é™ä½è§†è§‰æ•ˆæœå¼ºåº¦ï¼Œå‡å°‘GPUè´Ÿæ‹…</li>
                            <li>ä¼˜åŒ–å¤„ç†æ‰¹æ¬¡ï¼Œå‡å°‘å†…å­˜å ç”¨</li>
                            <li>è‡ªåŠ¨ç¦ç”¨æ€§èƒ½ç›‘æ§ï¼ŒèŠ‚çœèµ„æº</li>
                        </ul>
                    </div>
                    <div style="text-align: center;">
                        <button class="glass-btn glass-btn-primary" onclick="togglePerformanceMode(); this.closest('.modal').remove();" style="margin-right: 10px;">
                            ${ecoMode ? 'âœ¨ åˆ‡æ¢åˆ°æ ‡å‡†æ¨¡å¼' : 'ğŸŒ¿ åˆ‡æ¢åˆ°æç®€æ¨¡å¼'}
                        </button>
                        <button class="glass-btn glass-btn-danger" onclick="this.closest('.modal').remove()">
                            âŒ å…³é—­
                        </button>
                    </div>
                </div>
            `;
            modal.className = 'modal';
            document.body.appendChild(modal);
        }

        // è°ƒè¯•ä¸‹è½½ç³»ç»Ÿ
        async function debugDownloadSystem() {
            try {
                // è·å–è¯¦ç»†è°ƒè¯•ä¿¡æ¯
                const [listResponse, debugResponse] = await Promise.all([
                    fetch('/download-list'),
                    fetch('/debug-downloads')
                ]);
                
                const listData = await listResponse.json();
                const debugData = await debugResponse.json();
                
                const debugInfo = `
ğŸ”§ ä¸‹è½½ç³»ç»Ÿè¯¦ç»†è°ƒè¯•æŠ¥å‘Š
================================

ğŸ“‚ ç³»ç»Ÿä¿¡æ¯:
â”œâ”€ ä¸‹è½½ç›®å½•: ${debugData.downloads_dir || 'unknown'}
â”œâ”€ ç›®å½•å­˜åœ¨: ${debugData.dir_exists ? 'âœ… æ˜¯' : 'âŒ å¦'}  
â”œâ”€ æ˜¯å¦ä¸ºç›®å½•: ${debugData.is_directory ? 'âœ… æ˜¯' : 'âŒ å¦'}
â”œâ”€ ç›®å½•æƒé™: ${debugData.permissions || 'N/A'}
â””â”€ æ€»å¤§å°: ${debugData.total_size ? (debugData.total_size / 1024 / 1024).toFixed(2) + 'MB' : '0MB'}

ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:
â”œâ”€ APIè¿”å›æ–‡ä»¶æ•°: ${listData.files ? listData.files.length : 0}
â”œâ”€ å®é™…PDFæ–‡ä»¶æ•°: ${debugData.total_files || 0}
â”œâ”€ ç›®å½•æ‰€æœ‰æ–‡ä»¶æ•°: ${debugData.all_files ? debugData.all_files.length : 0}
â””â”€ çŠ¶æ€æ¶ˆæ¯: ${listData.message || 'none'}

ğŸ“‹ è¯¦ç»†æ–‡ä»¶åˆ—è¡¨:
APIè¿”å›çš„æ–‡ä»¶:
${listData.files && listData.files.length > 0 ? 
    listData.files.map((file, index) => `  ${index + 1}. ${file}`).join('\n') : 
    '  (æ— æ–‡ä»¶)'}

å®é™…ç›®å½•ä¸­çš„PDFæ–‡ä»¶:
${debugData.pdf_files && debugData.pdf_files.length > 0 ? 
    debugData.pdf_files.map((file, index) => {
        const sizeInfo = debugData.file_sizes && debugData.file_sizes[file] ? 
            ` (${debugData.file_sizes[file].size_mb}MB)` : '';
        return `  ${index + 1}. ${file}${sizeInfo}`;
    }).join('\n') : 
    '  (æ— PDFæ–‡ä»¶)'}

ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶:
${debugData.all_files && debugData.all_files.length > 0 ? 
    debugData.all_files.map((file, index) => `  ${index + 1}. ${file}`).join('\n') : 
    '  (ç›®å½•ä¸ºç©º)'}

ğŸ› ï¸ é—®é¢˜è¯Šæ–­:
${!debugData.dir_exists ? 'âŒ ä¸‹è½½ç›®å½•ä¸å­˜åœ¨ - éœ€è¦å…ˆå¤„ç†æ–‡ä»¶åˆ›å»ºç›®å½•\n' : ''}
${debugData.dir_exists && !debugData.is_directory ? 'âŒ downloadsè·¯å¾„å­˜åœ¨ä½†ä¸æ˜¯ç›®å½•\n' : ''}
${debugData.total_files === 0 ? 'âš ï¸  æ²¡æœ‰PDFæ–‡ä»¶ - è¯·å…ˆä¸Šä¼ å¹¶å¤„ç†æ–‡ä»¶\n' : ''}
${debugData.total_files !== (listData.files ? listData.files.length : 0) ? 'âš ï¸  APIè¿”å›çš„æ–‡ä»¶æ•°ä¸å®é™…ä¸ç¬¦\n' : ''}
${debugData.total_files === 1 ? 'âš ï¸  åªæœ‰1ä¸ªæ–‡ä»¶ - è¿™å¯èƒ½æ˜¯é—®é¢˜æ‰€åœ¨\n' : ''}
${debugData.error || listData.error ? `âŒ ç³»ç»Ÿé”™è¯¯: ${debugData.error || listData.error}\n` : ''}
${debugData.permissions === '000' ? 'âŒ ç›®å½•æƒé™é—®é¢˜\n' : ''}

ğŸ’¡ å»ºè®®è§£å†³æ–¹æ¡ˆ:
${debugData.total_files === 0 ? '1. ä¸Šä¼ PDFæ–‡ä»¶å¹¶ç‚¹å‡»"è¯†åˆ«å¹¶å¤„ç†æ–‡ä»¶"\n' : ''}
${debugData.total_files === 1 ? '2. æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªæ–‡ä»¶è¢«é‡å‘½åä¸ºåŒä¸€ä¸ªåç§°\n' : ''}
${debugData.total_files !== (listData.files ? listData.files.length : 0) ? '3. åˆ·æ–°é¡µé¢æˆ–é‡å¯æœåŠ¡\n' : ''}
`;

                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                    background: rgba(0,0,0,0.5); z-index: 10000; 
                    display: flex; align-items: center; justify-content: center;
                `;
                modal.innerHTML = `
                    <div class="glass-card" style="max-width: 600px; max-height: 80vh; overflow-y: auto; margin: 20px; padding: 30px;">
                        <h3 style="margin-bottom: 20px; text-align: center; color: #444;">ğŸ”§ ä¸‹è½½ç³»ç»Ÿè°ƒè¯•</h3>
                        <pre style="
                            background: rgba(0,0,0,0.1); 
                            padding: 15px; 
                            border-radius: 8px; 
                            font-family: monospace; 
                            font-size: 0.9rem; 
                            white-space: pre-wrap; 
                            margin-bottom: 20px;
                            color: #333;
                            max-height: 400px;
                            overflow-y: auto;
                        ">${debugInfo}</pre>
                        <div style="text-align: center;">
                            <button class="glass-btn glass-btn-primary" onclick="location.reload()" style="margin-right: 10px;">
                                ğŸ”„ åˆ·æ–°é¡µé¢
                            </button>
                            <button class="glass-btn glass-btn-danger" onclick="this.closest('.modal').remove()">
                                âŒ å…³é—­
                            </button>
                        </div>
                    </div>
                `;
                modal.className = 'modal';
                document.body.appendChild(modal);
                
            } catch (error) {
                alert('è°ƒè¯•å¤±è´¥: ' + error.message);
            }
        }

        // è‡ªåŠ¨ä¿®å¤uploadsä¸­é—ç•™çš„æ–‡ä»¶
        async function autoFixUploads() {
            try {
                addLog('ğŸ”§ å¼€å§‹è‡ªåŠ¨ä¿®å¤uploadsä¸­çš„é—ç•™æ–‡ä»¶...', 'info');
                
                const response = await fetch('/auto-fix', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                console.log('è‡ªåŠ¨ä¿®å¤ç»“æœ:', data);
                
                let message = data.message;
                if (data.details && data.details.length > 0) {
                    message += '\n\nè¯¦ç»†ä¿¡æ¯:\n';
                    data.details.forEach(detail => {
                        if (detail.success) {
                            message += `âœ… ${detail.original} â†’ ${detail.moved_to}\n`;
                        } else {
                            message += `â„¹ï¸ ${detail.original}: ${detail.reason}\n`;
                        }
                    });
                }
                
                alert(message);
                addLog(`è‡ªåŠ¨ä¿®å¤å®Œæˆ: ç§»åŠ¨äº† ${data.fixed_count} ä¸ªæ–‡ä»¶`, 'success');
                
                // åˆ·æ–°ä¸‹è½½åˆ—è¡¨
                if (data.fixed_count > 0) {
                    await refreshDownloadList();
                }
                
            } catch (error) {
                console.error('è‡ªåŠ¨ä¿®å¤å¤±è´¥:', error);
                addLog(`è‡ªåŠ¨ä¿®å¤å¤±è´¥: ${error.message}`, 'error');
                alert('è‡ªåŠ¨ä¿®å¤å¤±è´¥: ' + error.message);
            }
        }

        // åˆ·æ–°ä¸‹è½½åˆ—è¡¨çš„è¾…åŠ©å‡½æ•°
        async function refreshDownloadList() {
            try {
                const response = await fetch('/download-list');
                const data = await response.json();
                console.log('åˆ·æ–°ä¸‹è½½åˆ—è¡¨:', data);
                addLog(`ä¸‹è½½åˆ—è¡¨å·²åˆ·æ–°: æ‰¾åˆ° ${data.count} ä¸ªæ–‡ä»¶`, 'info');
            } catch (error) {
                console.error('åˆ·æ–°ä¸‹è½½åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åˆ‡æ¢å¤„ç†ç»“æœè¯¦ç»†ä¿¡æ¯çš„æ˜¾ç¤º
        function toggleResultDetails(index) {
            const details = document.getElementById(`details-${index}`);
            const icon = document.getElementById(`expand-icon-${index}`);
            
            if (!details || !icon) return;
            
            const isHidden = details.style.display === 'none';
            
            if (isHidden) {
                // å±•å¼€
                details.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
                icon.textContent = 'â–²';
                
                // å¹³æ»‘å±•å¼€åŠ¨ç”»
                details.style.opacity = '0';
                details.style.maxHeight = '0';
                details.style.overflow = 'hidden';
                details.style.transition = 'all 0.3s ease';
                
                // è§¦å‘åŠ¨ç”»
                setTimeout(() => {
                    details.style.opacity = '1';
                    details.style.maxHeight = '1000px';
                }, 10);
                
                addLog(`å±•å¼€æ–‡ä»¶è¯¦æƒ…: ç´¢å¼•${index}`, 'info');
            } else {
                // æŠ˜å 
                details.style.opacity = '0';
                details.style.maxHeight = '0';
                icon.style.transform = 'rotate(0deg)';
                icon.textContent = 'â–¼';
                
                // åŠ¨ç”»ç»“æŸåéšè—
                setTimeout(() => {
                    details.style.display = 'none';
                    details.style.transition = '';
                    details.style.overflow = '';
                }, 300);
                
                addLog(`æŠ˜å æ–‡ä»¶è¯¦æƒ…: ç´¢å¼•${index}`, 'info');
            }
        }

        // æ‰¹é‡å±•å¼€/æŠ˜å æ‰€æœ‰ç»“æœ
        function toggleAllResults(expand = null) {
            const allResults = document.querySelectorAll('.result-item');
            let expandedCount = 0;
            let collapsedCount = 0;
            
            allResults.forEach((item, index) => {
                const details = document.getElementById(`details-${index}`);
                const icon = document.getElementById(`expand-icon-${index}`);
                
                if (!details || !icon) return;
                
                const isCurrentlyHidden = details.style.display === 'none';
                const shouldExpand = expand !== null ? expand : isCurrentlyHidden;
                
                if (shouldExpand && isCurrentlyHidden) {
                    toggleResultDetails(index);
                    expandedCount++;
                } else if (!shouldExpand && !isCurrentlyHidden) {
                    toggleResultDetails(index);
                    collapsedCount++;
                }
            });
            
            if (expandedCount > 0) {
                addLog(`æ‰¹é‡å±•å¼€äº† ${expandedCount} ä¸ªç»“æœè¯¦æƒ…`, 'info');
            }
            if (collapsedCount > 0) {
                addLog(`æ‰¹é‡æŠ˜å äº† ${collapsedCount} ä¸ªç»“æœè¯¦æƒ…`, 'info');
            }
        }

        // æ‰¹é‡é‡å‘½ååŠŸèƒ½
        async function batchRename() {
            if (selectedFiles.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©PDFæ–‡ä»¶ï¼');
                return;
            }

            if (confirm(`ç¡®å®šè¦æ‰¹é‡å¤„ç† ${selectedFiles.length} ä¸ªæ–‡ä»¶å—ï¼Ÿå¤„ç†å®Œæˆåå¯ä»¥é€‰æ‹©ä¸‹è½½é‡å‘½ååçš„æ–‡ä»¶ã€‚`)) {
                await processFiles();
            }
        }

        // ä¿®æ”¹åçš„æ–‡ä»¶å¤„ç†åŠŸèƒ½ - æ”¹ä¸ºä¸‹è½½æ¨¡å¼
        async function processFiles() {
            if (selectedFiles.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©PDFæ–‡ä»¶ï¼');
                return;
            }

            if (isProcessing) {
                alert('æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }

            isProcessing = true;
            performanceData.startTime = Date.now();
            performanceData.processedFiles = 0;

            const resultsSection = document.getElementById('resultsSection');
            const results = document.getElementById('results');
            const backupInfo = document.getElementById('backupInfo');

            showProgress();
            showOCRStatus('âš¡ å¯åŠ¨åŒé‡éªŒè¯OCRå¼•æ“...');
            resultsSection.style.display = 'none';

            try {
                // æ™ºèƒ½æ‰¹é‡å¤„ç† - ä¼˜åŒ–å¤§æ‰¹é‡æ–‡ä»¶æˆåŠŸç‡
                const batchSize = (() => {
                    if (ecoMode) return 1; // æç®€æ¨¡å¼å•ä¸ªå¤„ç†
                    if (selectedFiles.length > 50) return 1; // å¤§æ‰¹é‡ï¼šå•ä¸ªå¤„ç†
                    if (selectedFiles.length > 20) return 2; // ä¸­æ‰¹é‡ï¼šæ¯æ¬¡2ä¸ª
                    if (selectedFiles.length > 10) return 3; // å°æ‰¹é‡ï¼šæ¯æ¬¡3ä¸ª
                    return 5; // æå°‘é‡ï¼šæœ€å¤§å¹¶å‘
                })();
                
                // æ ¹æ®æ–‡ä»¶æ•°é‡å’Œæ‰¹æ¬¡å¤§å°åŠ¨æ€è°ƒæ•´å»¶è¿Ÿ
                const batchDelay = (() => {
                    if (ecoMode) return 1500; // æç®€æ¨¡å¼å»¶è¿Ÿæ›´é•¿
                    if (selectedFiles.length > 50) return 1500; // å¤§æ‰¹é‡ï¼šé•¿å»¶è¿Ÿç¡®ä¿ç¨³å®š
                    if (selectedFiles.length > 20) return 1200; // ä¸­æ‰¹é‡ï¼šä¸­ç­‰å»¶è¿Ÿ
                    if (selectedFiles.length > 10) return 800; // å°æ‰¹é‡ï¼šçŸ­å»¶è¿Ÿ
                    return 500; // æå°‘é‡ï¼šé€‚å½“å»¶è¿Ÿ
                })();
                
                const totalFiles = selectedFiles.length;
                let allResults = [];
                let totalSuccessCount = 0;
                
                addLog(`ğŸš€ æ™ºèƒ½æ‰¹é‡å¤„ç†å¼€å§‹: ${totalFiles}ä¸ªæ–‡ä»¶, æ‰¹æ¬¡å¤§å°=${batchSize}, å»¶è¿Ÿ=${batchDelay}ms`, 'info');

                for (let i = 0; i < totalFiles; i += batchSize) {
                    const batch = selectedFiles.slice(i, i + batchSize);
                    const batchNumber = Math.floor(i/batchSize) + 1;
                    const totalBatches = Math.ceil(totalFiles/batchSize);
                    
                    // æ‰¹æ¬¡é‡è¯•æœºåˆ¶
                    let batchSuccess = false;
                    let retryCount = 0;
                    const maxRetries = 3; // å¢åŠ é‡è¯•æ¬¡æ•°
                    
                    while (!batchSuccess && retryCount <= maxRetries) {
                        try {
                            const formData = new FormData();
                            
                            batch.forEach(file => {
                                formData.append('files', file);
                            });

                            formData.append('enableBackup', 'true');

                            const retryText = retryCount > 0 ? ` (é‡è¯•${retryCount}/${maxRetries})` : '';
                            updateProgress(i, totalFiles, `æ‰¹æ¬¡ ${batchNumber}/${totalBatches}${retryText}`);
                            updateOCRStatus(`âš¡ åŒå¼•æ“è¯†åˆ«æ‰¹æ¬¡ ${batchNumber}/${totalBatches}${retryText}...`);
                            
                            addLog(`ğŸ“¦ å¤„ç†æ‰¹æ¬¡ ${batchNumber}/${totalBatches}${retryText}, åŒ…å« ${batch.length} ä¸ªæ–‡ä»¶`, 'info');

                            // å¢åŠ è¶…æ—¶æ—¶é—´ï¼Œé€‚åº”OCRå¤„ç†
                            const timeoutMs = batch.length * 90000; // æ¯ä¸ªæ–‡ä»¶1.5åˆ†é’Ÿ
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

                            const response = await fetch('/upload', {
                                method: 'POST',
                                body: formData,
                                signal: controller.signal
                            });

                            clearTimeout(timeoutId);

                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }

                            const batchData = await response.json();
                            
                            // éªŒè¯å“åº”æ•°æ®
                            if (!batchData.results || !Array.isArray(batchData.results)) {
                                throw new Error('æœåŠ¡å™¨è¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                            }
                            
                            allResults = allResults.concat(batchData.results);
                            batchSuccess = true;
                            
                            const successCount = batchData.results.filter(r => r.success).length;
                            totalSuccessCount += successCount;
                            
                            addLog(`âœ… æ‰¹æ¬¡ ${batchNumber} å®Œæˆ: ${successCount}/${batch.length} ä¸ªæ–‡ä»¶æˆåŠŸ (æ€»è®¡: ${totalSuccessCount}/${i + batch.length})`, 'success');
                            
                            performanceData.processedFiles += batch.length;
                            updatePerformanceStats();

                        } catch (error) {
                            retryCount++;
                            const isTimeout = error.name === 'AbortError';
                            const errorType = isTimeout ? 'è¶…æ—¶' : 'é”™è¯¯';
                            const errorMsg = `âŒ æ‰¹æ¬¡ ${batchNumber} ${errorType} (å°è¯•${retryCount}/${maxRetries+1}): ${error.message}`;
                            addLog(errorMsg, 'error');
                            
                            if (retryCount <= maxRetries) {
                                const retryDelay = batchDelay * (retryCount + 1); // é€’å¢å»¶è¿Ÿ
                                addLog(`â³ ç­‰å¾… ${retryDelay}ms åé‡è¯•...`, 'warning');
                                await new Promise(resolve => setTimeout(resolve, retryDelay));
                            } else {
                                // æœ€ç»ˆå¤±è´¥ï¼Œè®°å½•å¹¶ç»§ç»­
                                addLog(`ğŸ’¥ æ‰¹æ¬¡ ${batchNumber} æœ€ç»ˆå¤±è´¥ï¼Œè·³è¿‡ç»§ç»­å¤„ç†`, 'error');
                                
                                // ä¸ºå¤±è´¥çš„æ–‡ä»¶åˆ›å»ºé”™è¯¯ç»“æœ
                                const failedResults = batch.map(file => ({
                                    filename: file.name,
                                    success: false,
                                    message: `âŒ æ‰¹æ¬¡å¤„ç†å¤±è´¥: ${errorType} - ${error.message}`,
                                    log: `ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯: ${error.message}`
                                }));
                                allResults = allResults.concat(failedResults);
                                batchSuccess = true; // è·³å‡ºé‡è¯•å¾ªç¯
                            }
                        }
                    }

                    // å¼ºåˆ¶å†…å­˜æ¸…ç†
                    if ('gc' in window) {
                        try {
                            window.gc();
                        } catch (e) {
                            // å¿½ç•¥GCé”™è¯¯
                        }
                    }

                    // æ‰¹æ¬¡é—´æ™ºèƒ½å»¶è¿Ÿ
                    if (i + batchSize < totalFiles) {
                        addLog(`ğŸ˜´ æ‰¹æ¬¡é—´å»¶è¿Ÿ ${batchDelay}ms...`, 'info');
                        await new Promise(resolve => setTimeout(resolve, batchDelay));
                    }
                }
                
                addLog(`ğŸ‰ æ‰¹é‡å¤„ç†å®Œæˆ! æ€»æˆåŠŸ: ${totalSuccessCount}/${totalFiles} ä¸ªæ–‡ä»¶`, totalSuccessCount > 0 ? 'success' : 'warning');

                updateProgress(totalFiles, totalFiles, 'å¤„ç†å®Œæˆ');

                // æ¨¡æ‹Ÿæœ€ç»ˆæ•°æ®ç»“æ„
                const data = {
                    results: allResults,
                    processed_count: allResults.filter(r => r.success).length,
                    total_count: totalFiles,
                    backup_info: allResults.length > 0 ? `æ–‡ä»¶å·²å¤„ç†ï¼Œå¯é€‰æ‹©ä¸‹è½½é‡å‘½ååçš„PDFæ–‡ä»¶` : null
                };
                
                hideProgress();
                hideOCRStatus();
                resultsSection.style.display = 'block';

                // ä¼˜åŒ–ç»“æœæ˜¾ç¤ºç®¡ç†
                processResults = data.results; // ä¿å­˜æ‰€æœ‰ç»“æœåˆ°å…¨å±€å˜é‡
                updateResultsDisplay();

                // æ˜¾ç¤ºæ‰¹é‡ä¸‹è½½é€‰é¡¹
                if (data.processed_count > 0) {
                    backupInfo.style.display = 'block';
                    backupInfo.innerHTML = `
                        <h4 style="margin-bottom: 15px;">ğŸ“¥ ä¸‹è½½é€‰é¡¹</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <button class="glass-btn glass-btn-primary" onclick="downloadAllFiles()" style="width: 100%;">
                                ğŸ“¦ æ‰¹é‡ä¸‹è½½ (ZIPå‹ç¼©åŒ…)
                            </button>
                            <button class="glass-btn glass-btn-success" onclick="showSelectiveDownload()" style="width: 100%;">
                                âœ… é€‰æ‹©æ€§ä¸‹è½½
                            </button>
                            <button class="glass-btn" onclick="showAvailableFiles()" style="width: 100%;">
                                ğŸ“‹ æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶
                            </button>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                            <button class="glass-btn" onclick="resultsState.allExpanded = true; updateResultsDisplay();" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); flex: 1; min-width: 120px;">
                                ğŸ“– å±•å¼€æ‰€æœ‰è¯¦æƒ…
                            </button>
                            <button class="glass-btn" onclick="resultsState.allExpanded = false; updateResultsDisplay();" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); flex: 1; min-width: 120px;">
                                ğŸ“‹ æŠ˜å æ‰€æœ‰è¯¦æƒ…
                            </button>
                            <button class="glass-btn" onclick="autoFixDownloads();" style="background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%); flex: 1; min-width: 120px;">
                                ğŸ”§ ä¿®å¤ä¸‹è½½é—®é¢˜
                            </button>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <p style="color: rgba(68,68,68,0.8); margin: 0; margin-bottom: 8px;">âœ… æˆåŠŸå¤„ç†: ${data.processed_count}/${data.total_count} ä¸ªæ–‡ä»¶</p>
                            <p style="color: rgba(68,68,68,0.8); margin: 0; margin-bottom: 8px;">â±ï¸ å¤„ç†æ—¶é—´: ${((Date.now() - performanceData.startTime) / 1000).toFixed(1)}ç§’</p>
                            <p style="color: rgba(68,68,68,0.7); font-size: 0.9rem; margin: 0;">
                                ğŸ’¡ æç¤ºï¼šç‚¹å‡»æ–‡ä»¶æ¡ç›®å¯å±•å¼€æŸ¥çœ‹è¯¦ç»†OCRæ—¥å¿—å’Œå¤‡ä»½ä¿¡æ¯
                            </p>
                        </div>
                        
                        <p style="color: rgba(68,68,68,0.7); font-size: 0.9rem; text-align: center; font-style: italic;">
                            ğŸ“ æ–‡ä»¶å·²å®‰å…¨ä¿å­˜ï¼ŒåŸæ–‡ä»¶å·²è‡ªåŠ¨å¤‡ä»½ï¼Œå¯éšæ—¶ä¸‹è½½
                        </p>
                        <p style="color: rgba(68,68,68,0.7); font-size: 0.9rem; text-align: center; font-style: italic;">
                            âš ï¸ å¦‚æœä¸‹è½½æ—¶æç¤º"æ–‡ä»¶ä¸å­˜åœ¨"ï¼Œè¯·ç‚¹å‡»"ä¿®å¤ä¸‹è½½é—®é¢˜"æŒ‰é’®
                        </p>
                    `;
                }

                // é‡ç½®æ–‡ä»¶é€‰æ‹©
                selectedFiles = [];
                document.getElementById('fileInput').value = '';
                updateFileList();

            } catch (error) {
                hideProgress();
                hideOCRStatus();
                alert('å¤„ç†å¤±è´¥: ' + error.message);
            } finally {
                isProcessing = false;
            }
        }

        // æ–°å¢ï¼šä¸‹è½½åŠŸèƒ½
        async function downloadSingleFile(filename) {
            try {
                // é¢å¤–æ—¥å¿—ä»¥è¾…åŠ©è°ƒè¯•
                console.log(`å‡†å¤‡ä¸‹è½½æ–‡ä»¶: ${filename}`);
                addLog(`ğŸ” å¼€å§‹ä¸‹è½½æ–‡ä»¶: ${filename}`, 'info');
                
                // ç¡®ä¿æ­£ç¡®ç¼–ç æ–‡ä»¶åä¸­çš„ç‰¹æ®Šå­—ç¬¦
                const encodedFilename = encodeURIComponent(filename);
                console.log(`å°è¯•ä¸‹è½½æ–‡ä»¶: ${filename} (ç¼–ç å: ${encodedFilename})`);
                
                const response = await fetch(`/download/${encodedFilename}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    addLog(`âœ… æ–‡ä»¶ ${filename} ä¸‹è½½æˆåŠŸ`, 'success');
                } else {
                    // è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯
                    let errorDetail = '';
                    try {
                        const errorJson = await response.json();
                        errorDetail = errorJson.detail || response.statusText;
                    } catch (e) {
                        errorDetail = response.statusText;
                    }
                    
                    console.error(`ä¸‹è½½å¤±è´¥ ${filename}: ${response.status} - ${errorDetail}`);
                    addLog(`âŒ æ–‡ä»¶ ${filename} ä¸‹è½½å¤±è´¥: ${errorDetail}`, 'error');
                    
                    // ä¸‹è½½å¤±è´¥æ—¶æç¤ºè‡ªåŠ¨ä¿®å¤
                    if (confirm(`ä¸‹è½½å¤±è´¥ï¼š${errorDetail}\n\næ–‡ä»¶å: ${filename}\n\næ˜¯å¦å°è¯•è‡ªåŠ¨ä¿®å¤ï¼Ÿ`)) {
                        await autoFixDownloads();
                        // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                        await refreshDownloadList();
                        // ä¿®å¤åå†æ¬¡å°è¯•ä¸‹è½½
                        setTimeout(() => downloadSingleFile(filename), 1000);
                    } else {
                        alert(`ä¸‹è½½å¤±è´¥ï¼š${errorDetail}\n\næ‚¨å¯ä»¥ç‚¹å‡»"ä¿®å¤ä¸‹è½½"æŒ‰é’®å°è¯•ä¿®å¤ï¼Œæˆ–æ£€æŸ¥æ–‡ä»¶åç§°æ˜¯å¦åŒ¹é…ã€‚`);
                    }
                }
            } catch (error) {
                console.error(`ä¸‹è½½è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`);
                addLog(`âŒ ä¸‹è½½è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`, 'error');
                alert('ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        async function downloadAllFiles() {
            try {
                const response = await fetch('/download-all', { method: 'POST' });
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'renamed_pdfs.zip';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const errorData = await response.json();
                    alert('æ‰¹é‡ä¸‹è½½å¤±è´¥: ' + errorData.detail);
                }
            } catch (error) {
                alert('æ‰¹é‡ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        async function showAvailableFiles() {
            try {
                const response = await fetch('/download-list');
                const data = await response.json();
                
                // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºå®Œæ•´çš„å“åº”æ•°æ®
                console.log('ğŸ“‹ ä¸‹è½½åˆ—è¡¨è°ƒè¯•ä¿¡æ¯:', data);
                console.log('ğŸ“„ æ–‡ä»¶æ•°é‡:', data.files ? data.files.length : 0);
                console.log('ğŸ“„ æ–‡ä»¶åˆ—è¡¨:', data.files);
                
                if (data.files && data.files.length > 0) {
                    const fileList = data.files.map(file => 
                        `<div class="file-item" style="margin-bottom: 10px;">
                            <span>ğŸ“„ ${file}</span>
                            <button class="glass-btn" onclick="downloadSingleFile('${file}')" style="margin-left: 10px;">
                                ğŸ’¾ ä¸‹è½½
                            </button>
                        </div>`
                    ).join('');
                    
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                        background: rgba(0,0,0,0.5); z-index: 10000; 
                        display: flex; align-items: center; justify-content: center;
                    `;
                    modal.innerHTML = `
                        <div class="glass-card" style="max-width: 600px; max-height: 70vh; overflow-y: auto; margin: 20px; padding: 30px;">
                            <h3 style="margin-bottom: 20px; text-align: center; color: #444;">ğŸ“‹ å¯ä¸‹è½½æ–‡ä»¶åˆ—è¡¨ (${data.files.length}ä¸ª)</h3>
                            <div style="margin-bottom: 15px; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px; font-size: 0.9rem;">
                                <strong>è°ƒè¯•ä¿¡æ¯:</strong><br>
                                ç›®å½•: ${data.downloads_dir || 'unknown'}<br>
                                ç›®å½•å­˜åœ¨: ${data.dir_exists ? 'æ˜¯' : 'å¦'}<br>
                                æ¶ˆæ¯: ${data.message || 'none'}
                            </div>
                            <div style="margin-bottom: 20px;">
                                ${fileList}
                            </div>
                            <div style="text-align: center; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                                <button class="glass-btn glass-btn-primary" onclick="autoFixDownloads()" style="flex: 1;">
                                    ğŸ”§ ä¿®å¤ä¸‹è½½
                                </button>
                                <button class="glass-btn glass-btn-danger" onclick="this.closest('.modal').remove()" style="flex: 1;">
                                    âŒ å…³é—­
                                </button>
                            </div>
                        </div>
                    `;
                    modal.className = 'modal';
                    document.body.appendChild(modal);
                } else {
                    if (confirm('æš‚æ— å¯ä¸‹è½½çš„æ–‡ä»¶ã€‚æ˜¯å¦å°è¯•è‡ªåŠ¨ä¿®å¤ï¼Ÿ')) {
                        await autoFixDownloads();
                    } else {
                        alert(`æš‚æ— å¯ä¸‹è½½çš„æ–‡ä»¶\n\nè°ƒè¯•ä¿¡æ¯:\nç›®å½•: ${data.downloads_dir || 'unknown'}\nç›®å½•å­˜åœ¨: ${data.dir_exists ? 'æ˜¯' : 'å¦'}\næ¶ˆæ¯: ${data.message || 'none'}\né”™è¯¯: ${data.error || 'none'}`);
                    }
                }
            } catch (error) {
                console.error('è·å–æ–‡ä»¶åˆ—è¡¨é”™è¯¯:', error);
                alert('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        async function showSelectiveDownload() {
            try {
                const response = await fetch('/download-list');
                const data = await response.json();
                
                // è°ƒè¯•ä¿¡æ¯
                console.log('âœ… é€‰æ‹©æ€§ä¸‹è½½è°ƒè¯•ä¿¡æ¯:', data);
                
                if (data.files && data.files.length > 0) {
                    const fileCheckboxes = data.files.map(file => 
                        `<div style="margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" value="${file}" style="margin-right: 10px;">
                                <span>ğŸ“„ ${file}</span>
                            </label>
                        </div>`
                    ).join('');
                    
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                        background: rgba(0,0,0,0.5); z-index: 10000; 
                        display: flex; align-items: center; justify-content: center;
                    `;
                    modal.innerHTML = `
                        <div class="glass-card" style="max-width: 600px; max-height: 70vh; overflow-y: auto; margin: 20px; padding: 30px;">
                            <h3 style="margin-bottom: 20px; text-align: center; color: #444;">âœ… é€‰æ‹©è¦ä¸‹è½½çš„æ–‡ä»¶</h3>
                            <div style="margin-bottom: 20px;">
                                <div style="margin-bottom: 15px;">
                                    <button class="glass-btn" onclick="toggleAllCheckboxes(true)" style="margin-right: 10px;">å…¨é€‰</button>
                                    <button class="glass-btn" onclick="toggleAllCheckboxes(false)">å–æ¶ˆå…¨é€‰</button>
                                </div>
                                <div id="selectiveFileList">
                                    ${fileCheckboxes}
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <button class="glass-btn glass-btn-primary" onclick="downloadSelectedFiles()" style="margin-right: 10px;">
                                    ğŸ“¦ ä¸‹è½½é€‰ä¸­æ–‡ä»¶
                                </button>
                                <button class="glass-btn glass-btn-danger" onclick="this.closest('.modal').remove()">
                                    âŒ å…³é—­
                                </button>
                            </div>
                        </div>
                    `;
                    modal.className = 'modal';
                    document.body.appendChild(modal);
                } else {
                    alert('æš‚æ— å¯ä¸‹è½½çš„æ–‡ä»¶');
                }
            } catch (error) {
                alert('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        function toggleAllCheckboxes(checked) {
            const checkboxes = document.querySelectorAll('#selectiveFileList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checked);
        }

        async function downloadSelectedFiles() {
            const checkboxes = document.querySelectorAll('#selectiveFileList input[type="checkbox"]:checked');
            const selectedFiles = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedFiles.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
                return;
            }
            
            try {
                const response = await fetch('/download-selected', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(selectedFiles)
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'selected_pdfs.zip';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    document.querySelector('.modal').remove();
                } else {
                    const errorData = await response.json();
                    alert('ä¸‹è½½å¤±è´¥: ' + errorData.detail);
                }
            } catch (error) {
                alert('ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        async function clearFiles() {
            try {
                const response = await fetch('/clear', { method: 'POST' });
                const data = await response.json();
                
                // é‡ç½®ç•Œé¢
                selectedFiles = [];
                document.getElementById('fileInput').value = '';
                updateFileList();
                document.getElementById('resultsSection').style.display = 'none';
                
                alert(data.message);
            } catch (error) {
                alert('æ¸…ç†å¤±è´¥: ' + error.message);
            }
        }

        async function showBackupInfo() {
            try {
                const response = await fetch('/backup-info');
                const data = await response.json();
                
                const backupSection = document.getElementById('backupSection');
                const backupDetails = document.getElementById('backupDetails');
                
                if (data.backup_folders.length > 0) {
                    backupDetails.innerHTML = data.backup_folders.map(folder => 
                        `<div class="glass-card" style="margin-bottom: 15px; padding: 20px;">
                            <h4 style="color: #444; margin-bottom: 10px;">ğŸ“… ${folder.date}</h4>
                            <p style="color: rgba(68,68,68,0.8); margin-bottom: 10px;">æ–‡ä»¶æ•°é‡: ${folder.file_count}</p>
                            <div style="max-height: 150px; overflow-y: auto;">
                                ${folder.files.map(file => 
                                    `<div style="padding: 5px 0; color: rgba(68,68,68,0.7);">ğŸ“„ ${file}</div>`
                                ).join('')}
                            </div>
                            <button class="glass-btn glass-btn-danger" onclick="clearBackupByDate('${folder.date}')" style="margin-top: 10px;">
                                ğŸ—‘ï¸ æ¸…ç†${folder.date}å¤‡ä»½
                            </button>
                        </div>`
                    ).join('');
                } else {
                    backupDetails.innerHTML = '<p style="text-align: center; color: rgba(68,68,68,0.7);">æš‚æ— å¤‡ä»½æ–‡ä»¶</p>';
                }
                
                backupSection.style.display = 'block';
                backupSection.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                alert('è·å–å¤‡ä»½ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }

        async function clearBackupByDate(date) {
            if (!confirm(`ç¡®å®šè¦æ¸…ç† ${date} çš„å¤‡ä»½æ–‡ä»¶å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/clear-backup?date=${date}`, { method: 'POST' });
                const data = await response.json();
                alert(data.message);
                showBackupInfo(); // åˆ·æ–°å¤‡ä»½ä¿¡æ¯
            } catch (error) {
                alert('æ¸…ç†å¤‡ä»½å¤±è´¥: ' + error.message);
            }
        }

        async function clearAllBackups() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰å¤‡ä»½æ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }
            
            try {
                const response = await fetch('/clear-backup', { method: 'POST' });
                const data = await response.json();
                alert(data.message);
                showBackupInfo(); // åˆ·æ–°å¤‡ä»½ä¿¡æ¯
            } catch (error) {
                alert('æ¸…ç†æ‰€æœ‰å¤‡ä»½å¤±è´¥: ' + error.message);
            }
        }
        // ============ å®æ—¶æ—¥å¿—ç³»ç»Ÿ ============
        function addLog(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, message, level };
            logEntries.push(logEntry);
            
            // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡ï¼Œé¿å…å†…å­˜æ³„æ¼
            if (logEntries.length > 100) {
                logEntries.shift();
            }
            
            // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContent = document.getElementById('logContent');
            if (!logContent) return;
            
            const lastEntries = logEntries.slice(-20); // åªæ˜¾ç¤ºæœ€è¿‘20æ¡
            logContent.innerHTML = lastEntries.map(entry => 
                `<div class="log-entry">
                    <span class="log-timestamp">${entry.timestamp}</span>
                    <span class="log-level-${entry.level}">${entry.message}</span>
                </div>`
            ).join('');
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            try {
                logContent.scrollTop = logContent.scrollHeight;
            } catch (e) {
                // å¿½ç•¥æ»šåŠ¨é”™è¯¯
            }
        }

        function toggleLogVisibility() {
            logVisible = !logVisible;
            const logWindow = document.getElementById('realtimeLog');
            const toggleBtn = document.querySelector('.log-toggle');
            
            if (logWindow) {
                if (logVisible) {
                    logWindow.style.display = 'block';
                    if (toggleBtn) toggleBtn.textContent = 'ğŸ“‹ éšè—æ—¥å¿—';
                    addLog('å®æ—¶æ—¥å¿—çª—å£å·²å¼€å¯', 'info');
                } else {
                    logWindow.style.display = 'none';
                    if (toggleBtn) toggleBtn.textContent = 'ğŸ“‹ å®æ—¶æ—¥å¿—';
                }
            }
        }

        function clearLogs() {
            logEntries = [];
            updateLogDisplay();
            addLog('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        function exportLogs() {
            const logText = logEntries.map(entry => 
                `[${entry.timestamp}] ${entry.level.toUpperCase()}: ${entry.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pdf-renamer-logs-${new Date().toISOString().slice(0, 10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            addLog('æ—¥å¿—å·²å¯¼å‡º', 'success');
        }

        // ============ å¢å¼ºæ€§èƒ½ç›‘æ§ç³»ç»Ÿ ============
        function initEnhancedPerformanceMonitoring() {
            if (ecoMode) return;
            
            // å¯åŠ¨æ€§èƒ½æ•°æ®æ”¶é›†
            setInterval(() => {
                const panel = document.getElementById('performancePanel');
                if (panel && panel.style.display === 'block') {
                    updatePerformanceMetrics();
                }
            }, 2000);
        }

        function updatePerformanceMetrics() {
            try {
                // CPUä½¿ç”¨ç‡ï¼ˆè¿‘ä¼¼ï¼‰
                const start = performance.now();
                for (let i = 0; i < 10000; i++) Math.random();
                const cpuTime = performance.now() - start;
                const cpuUsage = Math.min(100, Math.max(0, (cpuTime - 1) * 10));
                
                // å†…å­˜ä½¿ç”¨
                const memoryInfo = performance.memory || {};
                const memoryUsed = Math.round((memoryInfo.usedJSHeapSize || 0) / 1024 / 1024);
                
                // å®‰å…¨æ›´æ–°ç•Œé¢å…ƒç´ 
                const perfCPU = document.getElementById('perfCPU');
                const perfMemory = document.getElementById('perfMemory');
                const perfTime = document.getElementById('perfTime');
                const perfFiles = document.getElementById('perfFiles');
                
                if (perfCPU) {
                    perfCPU.textContent = `${cpuUsage.toFixed(0)}%`;
                }
                if (perfMemory) {
                    perfMemory.textContent = `${memoryUsed}MB`;
                }
                if (perfTime && performanceData.startTime) {
                    const elapsed = (Date.now() - performanceData.startTime) / 1000;
                    perfTime.textContent = `${elapsed.toFixed(0)}s`;
                }
                if (perfFiles) {
                    perfFiles.textContent = performanceData.processedFiles;
                }
                
                // æ›´æ–°æ€§èƒ½å›¾è¡¨
                updatePerformanceChart(cpuUsage);
                
            } catch (e) {
                // å¿½ç•¥é”™è¯¯
            }
        }

        function updatePerformanceChart(value) {
            performanceChart.data.push(value);
            if (performanceChart.data.length > performanceChart.maxPoints) {
                performanceChart.data.shift();
            }
            
            const chartContainer = document.getElementById('perfChart');
            if (!chartContainer) return;
            
            chartContainer.innerHTML = '';
            const maxValue = Math.max(...performanceChart.data, 1);
            
            performanceChart.data.forEach((val, index) => {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.left = `${index * 6}px`;
                bar.style.height = `${(val / maxValue) * 50}px`;
                chartContainer.appendChild(bar);
            });
        }

        function togglePerformancePanel() {
            const panel = document.getElementById('performancePanel');
            if (!panel) return;
            
            const isVisible = panel.style.display === 'block';
            
            if (isVisible) {
                panel.style.display = 'none';
                addLog('æ€§èƒ½ç›‘æ§é¢æ¿å·²å…³é—­', 'info');
            } else {
                panel.style.display = 'block';
                addLog('æ€§èƒ½ç›‘æ§é¢æ¿å·²å¼€å¯', 'info');
                updatePerformanceMetrics();
            }
        }

        // ============ å¢å¼ºçš„æ€§èƒ½ç›‘æ§å‡½æ•° ============
        function showPerformanceInfo() {
            togglePerformancePanel();
        }

        // ============ é‡å†™æ–‡ä»¶å¤„ç†å‡½æ•°å¢åŠ æ—¥å¿— ============
        const originalProcessFiles = processFiles;
        processFiles = async function() {
            addLog(`å¼€å§‹å¤„ç† ${selectedFiles.length} ä¸ªPDFæ–‡ä»¶`, 'info');
            addLog('åŒé‡éªŒè¯OCRå¼•æ“å¯åŠ¨ä¸­...', 'info');
            
            try {
                await originalProcessFiles.call(this);
                addLog('æ–‡ä»¶å¤„ç†å®Œæˆï¼Œå¯ä¸‹è½½é‡å‘½ååçš„æ–‡ä»¶', 'success');
            } catch (error) {
                addLog(`å¤„ç†å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // æ·»åŠ è‡ªåŠ¨ä¿®å¤ä¸‹è½½æ–‡ä»¶åŠŸèƒ½
        async function autoFixDownloads() {
            try {
                addLog('ğŸ”§ å¯åŠ¨è‡ªåŠ¨ä¿®å¤...', 'info');
                
                // æ˜¾ç¤ºè¿›åº¦æç¤º
                const loadingModal = document.createElement('div');
                loadingModal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                    background: rgba(0,0,0,0.5); z-index: 10001; 
                    display: flex; align-items: center; justify-content: center;
                `;
                loadingModal.innerHTML = `
                    <div class="glass-card" style="padding: 30px; text-align: center;">
                        <h4 style="margin-bottom: 20px; color: #444;">ğŸ”„ æ­£åœ¨ä¿®å¤ä¸‹è½½...</h4>
                        <div style="display: inline-block; width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #ff6b9d; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 20px; color: #666;">æ­£åœ¨ä»å¤‡ä»½æ¢å¤æ–‡ä»¶ï¼Œè¯·ç¨å€™...</p>
                    </div>
                    <style>
                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }
                    </style>
                `;
                loadingModal.className = 'loading-modal';
                document.body.appendChild(loadingModal);
                
                const response = await fetch('/auto-fix', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // å…³é—­åŠ è½½æç¤º
                document.querySelector('.loading-modal').remove();
                
                // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                const resultModal = document.createElement('div');
                resultModal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                    background: rgba(0,0,0,0.5); z-index: 10000; 
                    display: flex; align-items: center; justify-content: center;
                `;
                
                let detailsHtml = '';
                if (data.details && data.details.length > 0) {
                    const successItems = data.details.filter(d => d.success).slice(0, 10); // é™åˆ¶æ˜¾ç¤ºæ•°é‡
                    if (successItems.length > 0) {
                        detailsHtml += `<div style="margin-top: 15px; background: rgba(0,255,0,0.05); padding: 10px; border-radius: 8px; max-height: 200px; overflow-y: auto;">`;
                        successItems.forEach(detail => {
                            const source = detail.source ? `(æ¥æº: ${detail.source})` : '';
                            detailsHtml += `<div style="margin-bottom: 5px; font-size: 0.9rem;">âœ… ${detail.original} â†’ ${detail.moved_to} ${source}</div>`;
                        });
                        if (data.details.filter(d => d.success).length > 10) {
                            detailsHtml += `<div style="font-style: italic; text-align: center; margin-top: 10px;">...ç­‰å…± ${data.details.filter(d => d.success).length} ä¸ªæˆåŠŸé¡¹</div>`;
                        }
                        detailsHtml += `</div>`;
                    }
                }
                
                resultModal.innerHTML = `
                    <div class="glass-card" style="max-width: 600px; max-height: 70vh; overflow-y: auto; margin: 20px; padding: 30px;">
                        <h3 style="margin-bottom: 20px; text-align: center; color: #444;">ğŸ”§ ä¿®å¤ç»“æœ</h3>
                        
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <p style="color: #444; margin: 0; margin-bottom: 8px;">âœ… ${data.message}</p>
                            <p style="color: rgba(68,68,68,0.8); margin: 0; margin-bottom: 5px;">
                                - ä»uploadsä¿®å¤: ${data.fixed_count}ä¸ªæ–‡ä»¶
                            </p>
                            <p style="color: rgba(68,68,68,0.8); margin: 0;">
                                - ä»å¤‡ä»½æ¢å¤: ${data.backup_files_added}ä¸ªæ–‡ä»¶
                            </p>
                        </div>
                        
                        ${detailsHtml}
                        
                        <div style="text-align: center; margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="glass-btn glass-btn-primary" onclick="showAvailableFiles(); this.closest('.modal').remove();" style="flex: 1;">
                                ğŸ“‹ æŸ¥çœ‹å¯ä¸‹è½½æ–‡ä»¶
                            </button>
                            <button class="glass-btn glass-btn-danger" onclick="this.closest('.modal').remove()" style="flex: 1;">
                                âŒ å…³é—­
                            </button>
                        </div>
                    </div>
                `;
                resultModal.className = 'modal';
                document.body.appendChild(resultModal);
                
                addLog(`è‡ªåŠ¨ä¿®å¤å®Œæˆ: æ¢å¤äº† ${data.total_fixed} ä¸ªæ–‡ä»¶`, 'success');
                
                // åˆ·æ–°ä¸‹è½½åˆ—è¡¨
                await refreshDownloadList();
                
                return data;
                
            } catch (error) {
                // å…³é—­å¯èƒ½å­˜åœ¨çš„åŠ è½½æç¤º
                const loadingModal = document.querySelector('.loading-modal');
                if (loadingModal) loadingModal.remove();
                
                console.error('è‡ªåŠ¨ä¿®å¤å¤±è´¥:', error);
                addLog(`è‡ªåŠ¨ä¿®å¤å¤±è´¥: ${error.message}`, 'error');
                alert('è‡ªåŠ¨ä¿®å¤å¤±è´¥: ' + error.message);
                
                return null;
            }
        }

    </script>
</body>
</html>

